<div class="announce instapaper_body md" data-path="README.md" id="readme"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><p><a href="grape.png" target="_blank"><img src="grape.png" alt="grape logo" style="max-width:100%;"></a></p>

<p><a href="http://travis-ci.org/intridea/grape"><img src="https://camo.githubusercontent.com/bf4936b8ce902fc93a8c188954b3126dfe13b7ac/68747470733a2f2f7472617669732d63692e6f72672f696e7472696465612f67726170652e706e673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/intridea/grape.png?branch=master" style="max-width:100%;"></a> <a href="https://codeclimate.com/github/intridea/grape"><img src="https://camo.githubusercontent.com/11fd01e375907c9ff39dc87687f2f4211cfa75ca/68747470733a2f2f636f6465636c696d6174652e636f6d2f6769746875622f696e7472696465612f67726170652e706e67" alt="Code Climate" data-canonical-src="https://codeclimate.com/github/intridea/grape.png" style="max-width:100%;"></a> <a href="http://inch-ci.org/github/intridea/grape"><img src="https://camo.githubusercontent.com/974b8931c3d00ab314e4d603d8c246d6c3b40c59/687474703a2f2f696e63682d63692e6f72672f6769746875622f696e7472696465612f67726170652e706e67" alt="Inline docs" data-canonical-src="http://inch-ci.org/github/intridea/grape.png" style="max-width:100%;"></a> <a href="https://www.versioneye.com/ruby/grape/0.7.0"><img src="https://camo.githubusercontent.com/bbbb69f7682cb78f8575b0b081a84d6409929b00/68747470733a2f2f7777772e76657273696f6e6579652e636f6d2f727562792f67726170652f302e372e302f62616467652e706e67" alt="Dependency Status" data-canonical-src="https://www.versioneye.com/ruby/grape/0.7.0/badge.png" style="max-width:100%;"></a></p>

<h2>
<a name="user-content-table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of Contents</h2>

<ul class="task-list">
<li><a href="#what-is-grape">What is Grape?</a></li>
<li><a href="#stable-release">Stable Release</a></li>
<li><a href="#project-resources">Project Resources</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#basic-usage">Basic Usage</a></li>
<li>
<a href="#mounting">Mounting</a>

<ul class="task-list">
<li><a href="#rack">Rack</a></li>
<li><a href="#alongside-sinatra-or-other-frameworks">Alongside Sinatra (or other frameworks)</a></li>
<li><a href="#rails">Rails</a></li>
<li><a href="#modules">Modules</a></li>
</ul>
</li>
<li>
<a href="#versioning">Versioning</a>

<ul class="task-list">
<li><a href="#path">Path</a></li>
<li><a href="#header">Header</a></li>
<li><a href="#accept-version-header">Accept-Version Header</a></li>
<li><a href="#param">Param</a></li>
</ul>
</li>
<li><a href="#describing-methods">Describing Methods</a></li>
<li><a href="#parameters">Parameters</a></li>
<li>
<a href="#parameter-validation-and-coercion">Parameter Validation and Coercion</a>

<ul class="task-list">
<li><a href="#namespace-validation-and-coercion">Namespace Validation and Coercion</a></li>
<li><a href="#custom-validators">Custom Validators</a></li>
<li><a href="#validation-errors">Validation Errors</a></li>
<li><a href="#i18n">I18n</a></li>
</ul>
</li>
<li><a href="#headers">Headers</a></li>
<li><a href="#routes">Routes</a></li>
<li><a href="#helpers">Helpers</a></li>
<li><a href="#parameter-documentation">Parameter Documentation</a></li>
<li><a href="#cookies">Cookies</a></li>
<li><a href="#http-status-code">HTTP Status Code</a></li>
<li><a href="#redirecting">Redirecting</a></li>
<li><a href="#allowed-methods">Allowed Methods</a></li>
<li>
<a href="#raising-exceptions">Raising Exceptions</a>

<ul class="task-list">
<li><a href="#default-error-http-status-code">Default Error HTTP Status Code</a></li>
<li><a href="#handling-404">Handling 404</a></li>
</ul>
</li>
<li>
<a href="#exception-handling">Exception Handling</a>

<ul class="task-list">
<li><a href="#rails-3x">Rails 3.x</a></li>
</ul>
</li>
<li><a href="#logging">Logging</a></li>
<li>
<a href="#api-formats">API Formats</a>

<ul class="task-list">
<li><a href="#jsonp">JSONP</a></li>
<li><a href="#cors">CORS</a></li>
</ul>
</li>
<li><a href="#content-type">Content-type</a></li>
<li><a href="#api-data-formats">API Data Formats</a></li>
<li>
<a href="#restful-model-representations">RESTful Model Representations</a>

<ul class="task-list">
<li><a href="#grape-entities">Grape Entities</a></li>
<li><a href="#hypermedia">Hypermedia</a></li>
<li><a href="#rabl">Rabl</a></li>
<li><a href="#active-model-serializers">Active Model Serializers</a></li>
</ul>
</li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#describing-and-inspecting-an-api">Describing and Inspecting an API</a></li>
<li><a href="#current-route-and-endpoint">Current Route and Endpoint</a></li>
<li><a href="#before-and-after">Before and After</a></li>
<li><a href="#anchoring">Anchoring</a></li>
<li>
<a href="#writing-tests">Writing Tests</a>

<ul class="task-list">
<li><a href="#writing-tests-with-rack">Writing Tests with Rack</a></li>
<li><a href="#writing-tests-with-rails">Writing Tests with Rails</a></li>
<li><a href="#stubbing-helpers">Stubbing Helpers</a></li>
</ul>
</li>
<li>
<a href="#reloading-api-changes-in-development">Reloading API Changes in Development</a>

<ul class="task-list">
<li><a href="#rails-3x">Rails 3.x</a></li>
</ul>
</li>
<li><a href="#performance-monitoring">Performance Monitoring</a></li>
<li><a href="#contributing-to-grape">Contributing to Grape</a></li>
<li><a href="#hacking-on-grape">Hacking on Grape</a></li>
<li><a href="#license">License</a></li>
<li><a href="#copyright">Copyright</a></li>
</ul><h2>
<a name="user-content-what-is-grape" class="anchor" href="#what-is-grape" aria-hidden="true"><span class="octicon octicon-link"></span></a>What is Grape?</h2>

<p>Grape is a REST-like API micro-framework for Ruby. It's designed to run on Rack
or complement existing web application frameworks such as Rails and Sinatra by
providing a simple DSL to easily develop RESTful APIs. It has built-in support
for common conventions, including multiple formats, subdomain/prefix restriction,
content negotiation, versioning and much more.</p>

<h2>
<a name="user-content-stable-release" class="anchor" href="#stable-release" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stable Release</h2>

<p>You're reading the documentation for the next release of Grape, which should be 0.8.1.
Please read <a href="UPGRADING.md">UPGRADING</a> when upgrading from a previous version.
The current stable release is <a href="https://github.com/intridea/grape/blob/v0.8.0/README.md">0.8.0</a>.</p>

<h2>
<a name="user-content-project-resources" class="anchor" href="#project-resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Project Resources</h2>

<ul class="task-list">
<li>Need help? <a href="http://groups.google.com/group/ruby-grape">Grape Google Group</a>
</li>
<li><a href="https://github.com/intridea/grape/wiki">Grape Wiki</a></li>
</ul><h2>
<a name="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Grape is available as a gem, to install it just install the gem:</p>

<pre><code>gem install grape
</code></pre>

<p>If you're using Bundler, add the gem to Gemfile.</p>

<pre><code>gem 'grape'
</code></pre>

<p>Run <code>bundle install</code>.</p>

<h2>
<a name="user-content-basic-usage" class="anchor" href="#basic-usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic Usage</h2>

<p>Grape APIs are Rack applications that are created by subclassing <code>Grape::API</code>.
Below is a simple example showing some of the more common features of Grape in
the context of recreating parts of the Twitter API.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">Twitter</span>
  <span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
    <span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:header</span><span class="p">,</span> <span class="ss">vendor</span><span class="p">:</span> <span class="s1">'twitter'</span>
    <span class="nb">format</span> <span class="ss">:json</span>

    <span class="n">helpers</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">current_user</span>
        <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">authorize!</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">authenticate!</span>
        <span class="n">error!</span><span class="p">(</span><span class="s1">'401 Unauthorized'</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">resource</span> <span class="ss">:statuses</span> <span class="k">do</span>
      <span class="n">desc</span> <span class="s2">"Return a public timeline."</span>
      <span class="n">get</span> <span class="ss">:public_timeline</span> <span class="k">do</span>
        <span class="no">Status</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="s2">"Return a personal timeline."</span>
      <span class="n">get</span> <span class="ss">:home_timeline</span> <span class="k">do</span>
        <span class="n">authenticate!</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="s2">"Return a status."</span>
      <span class="n">params</span> <span class="k">do</span>
        <span class="n">requires</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Status id."</span>
      <span class="k">end</span>
      <span class="n">route_param</span> <span class="ss">:id</span> <span class="k">do</span>
        <span class="n">get</span> <span class="k">do</span>
          <span class="no">Status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="s2">"Create a status."</span>
      <span class="n">params</span> <span class="k">do</span>
        <span class="n">requires</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Your status."</span>
      <span class="k">end</span>
      <span class="n">post</span> <span class="k">do</span>
        <span class="n">authenticate!</span>
        <span class="no">Status</span><span class="o">.</span><span class="n">create!</span><span class="p">({</span>
          <span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span>
          <span class="ss">text</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
        <span class="p">})</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="s2">"Update a status."</span>
      <span class="n">params</span> <span class="k">do</span>
        <span class="n">requires</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Status ID."</span>
        <span class="n">requires</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Your status."</span>
      <span class="k">end</span>
      <span class="n">put</span> <span class="s1">':id'</span> <span class="k">do</span>
        <span class="n">authenticate!</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
          <span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span>
          <span class="ss">text</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
        <span class="p">})</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="s2">"Delete a status."</span>
      <span class="n">params</span> <span class="k">do</span>
        <span class="n">requires</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Status ID."</span>
      <span class="k">end</span>
      <span class="n">delete</span> <span class="s1">':id'</span> <span class="k">do</span>
        <span class="n">authenticate!</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-mounting" class="anchor" href="#mounting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mounting</h2>

<h3>
<a name="user-content-rack" class="anchor" href="#rack" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rack</h3>

<p>The above sample creates a Rack application that can be run from a rackup <code>config.ru</code> file
with <code>rackup</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="n">run</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span>
</pre></div>

<p>And would respond to the following routes:</p>

<pre><code>GET /statuses/public_timeline(.json)
GET /statuses/home_timeline(.json)
GET /statuses/:id(.json)
POST /statuses(.json)
PUT /statuses/:id(.json)
DELETE /statuses/:id(.json)
</code></pre>

<p>Grape will also automatically respond to HEAD and OPTIONS for all GET, and just OPTIONS for all other routes.</p>

<h3>
<a name="user-content-alongside-sinatra-or-other-frameworks" class="anchor" href="#alongside-sinatra-or-other-frameworks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Alongside Sinatra (or other frameworks)</h3>

<p>If you wish to mount Grape alongside another Rack framework such as Sinatra, you can do so easily using
<code>Rack::Cascade</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># Example config.ru</span>

<span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'grape'</span>

<span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">get</span> <span class="ss">:hello</span> <span class="k">do</span>
    <span class="p">{</span> <span class="ss">hello</span><span class="p">:</span> <span class="s2">"world"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Web</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s2">"Hello world."</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Cookie</span>
<span class="n">run</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cascade</span><span class="o">.</span><span class="n">new</span> <span class="o">[</span><span class="no">API</span><span class="p">,</span> <span class="no">Web</span><span class="o">]</span>
</pre></div>

<h3>
<a name="user-content-rails" class="anchor" href="#rails" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rails</h3>

<p>Place API files into <code>app/api</code>. Rails expects a subdirectory that matches the name of the Ruby module and a file name that matches the name of the class. In our example, the file name location and directory for <code>Twitter::API</code> should be <code>app/api/twitter/api.rb</code>.</p>

<p>Modify <code>application.rb</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">add</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="s1">'api'</span><span class="p">),</span> <span class="ss">glob</span><span class="p">:</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'**'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="s1">'api'</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">)</span><span class="o">]</span>
</pre></div>

<p>Modify <code>config/routes</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="n">mount</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">=&gt;</span> <span class="s1">'/'</span>
</pre></div>

<p>See below for additional code that enables reloading of API changes in development.</p>

<h3>
<a name="user-content-modules" class="anchor" href="#modules" aria-hidden="true"><span class="octicon octicon-link"></span></a>Modules</h3>

<p>You can mount multiple API implementations inside another one. These don't have to be
different versions, but may be components of the same API.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">mount</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">APIv1</span>
  <span class="n">mount</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">APIv2</span>
<span class="k">end</span>
</pre></div>

<p>You can also mount on a path, which is similar to using <code>prefix</code> inside the mounted API itself.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">mount</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">APIv1</span> <span class="o">=&gt;</span> <span class="s1">'/v1'</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-versioning" class="anchor" href="#versioning" aria-hidden="true"><span class="octicon octicon-link"></span></a>Versioning</h2>

<p>There are four strategies in which clients can reach your API's endpoints: <code>:path</code>,
<code>:header</code>, <code>:accept_version_header</code> and <code>:param</code>. The default strategy is <code>:path</code>.</p>

<h3>
<a name="user-content-path" class="anchor" href="#path" aria-hidden="true"><span class="octicon octicon-link"></span></a>Path</h3>

<div class="highlight highlight-ruby"><pre><span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:path</span>
</pre></div>

<p>Using this versioning strategy, clients should pass the desired version in the URL.</p>

<pre><code>curl -H http://localhost:9292/v1/statuses/public_timeline
</code></pre>

<h3>
<a name="user-content-header" class="anchor" href="#header" aria-hidden="true"><span class="octicon octicon-link"></span></a>Header</h3>

<div class="highlight highlight-ruby"><pre><span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:header</span><span class="p">,</span> <span class="ss">vendor</span><span class="p">:</span> <span class="s1">'twitter'</span>
</pre></div>

<p>Using this versioning strategy, clients should pass the desired version in the HTTP <code>Accept</code> head.</p>

<pre><code>curl -H Accept:application/vnd.twitter-v1+json http://localhost:9292/statuses/public_timeline
</code></pre>

<p>By default, the first matching version is used when no <code>Accept</code> header is
supplied. This behavior is similar to routing in Rails. To circumvent this default behavior,
one could use the <code>:strict</code> option. When this option is set to <code>true</code>, a <code>406 Not Acceptable</code> error
is returned when no correct <code>Accept</code> header is supplied.</p>

<p>When an invalid <code>Accept</code> header is supplied, a <code>406 Not Acceptable</code> error is returned if the <code>:cascade</code>
option is set to <code>false</code>. Otherwise a <code>404 Not Found</code> error is returned by Rack if no other route
matches.</p>

<h3>
<a name="user-content-http-status-code" class="anchor" href="#http-status-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>HTTP Status Code</h3>

<p>By default Grape returns a 200 status code for <code>GET</code>-Requests and 201 for <code>POST</code>-Requests.
You can use <code>status</code> to query and set the actual HTTP Status Code</p>

<div class="highlight highlight-ruby"><pre><span class="n">post</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">202</span>

  <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
     <span class="c1"># do some thing</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-accept-version-header" class="anchor" href="#accept-version-header" aria-hidden="true"><span class="octicon octicon-link"></span></a>Accept-Version Header</h3>

<div class="highlight highlight-ruby"><pre><span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:accept_version_header</span>
</pre></div>

<p>Using this versioning strategy, clients should pass the desired version in the HTTP <code>Accept-Version</code> header.</p>

<pre><code>curl -H "Accept-Version:v1" http://localhost:9292/statuses/public_timeline
</code></pre>

<p>By default, the first matching version is used when no <code>Accept-Version</code> header is
supplied. This behavior is similar to routing in Rails. To circumvent this default behavior,
one could use the <code>:strict</code> option. When this option is set to <code>true</code>, a <code>406 Not Acceptable</code> error
is returned when no correct <code>Accept</code> header is supplied.</p>

<h3>
<a name="user-content-param" class="anchor" href="#param" aria-hidden="true"><span class="octicon octicon-link"></span></a>Param</h3>

<div class="highlight highlight-ruby"><pre><span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:param</span>
</pre></div>

<p>Using this versioning strategy, clients should pass the desired version as a request parameter,
either in the URL query string or in the request body.</p>

<pre><code>curl -H http://localhost:9292/statuses/public_timeline?apiver=v1
</code></pre>

<p>The default name for the query parameter is 'apiver' but can be specified using the <code>:parameter</code> option.</p>

<div class="highlight highlight-ruby"><pre><span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:param</span><span class="p">,</span> <span class="ss">parameter</span><span class="p">:</span> <span class="s2">"v"</span>
</pre></div>

<pre><code>curl -H http://localhost:9292/statuses/public_timeline?v=v1
</code></pre>

<h2>
<a name="user-content-describing-methods" class="anchor" href="#describing-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Describing Methods</h2>

<p>You can add a description to API methods and namespaces.</p>

<div class="highlight highlight-ruby"><pre><span class="n">desc</span> <span class="s2">"Returns your public timeline."</span>
<span class="n">get</span> <span class="ss">:public_timeline</span> <span class="k">do</span>
  <span class="no">Status</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-parameters" class="anchor" href="#parameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Parameters</h2>

<p>Request parameters are available through the <code>params</code> hash object. This includes <code>GET</code>, <code>POST</code>
and <code>PUT</code> parameters, along with any named parameters you specify in your route strings.</p>

<div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="ss">:public_timeline</span> <span class="k">do</span>
  <span class="no">Status</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:sort_by</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>Parameters are automatically populated from the request body on <code>POST</code> and <code>PUT</code> for form input, JSON and
XML content-types.</p>

<p>The request:</p>

<pre><code>curl -d '{"text": "140 characters"}' 'http://localhost:9292/statuses' -H Content-Type:application/json -v
</code></pre>

<p>The Grape endpoint:</p>

<div class="highlight highlight-ruby"><pre><span class="n">post</span> <span class="s1">'/statuses'</span> <span class="k">do</span>
  <span class="no">Status</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">text</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>Multipart POSTs and PUTs are supported as well.</p>

<p>The request:</p>

<pre><code>curl --form image_file=@image.jpg http://localhost:9292/upload
</code></pre>

<p>The Grape endpoint:</p>

<div class="highlight highlight-ruby"><pre><span class="n">post</span> <span class="s2">"upload"</span> <span class="k">do</span>
  <span class="c1"># file in params[:image_file]</span>
<span class="k">end</span>
</pre></div>

<p>In the case of conflict between either of:</p>

<ul class="task-list">
<li>route string parameters</li>
<li>
<code>GET</code>, <code>POST</code> and <code>PUT</code> parameters</li>
<li>the contents of the request body on <code>POST</code> and <code>PUT</code>
</li>
</ul><p>route string parameters will have precedence.</p>

<h2>
<a name="user-content-parameter-validation-and-coercion" class="anchor" href="#parameter-validation-and-coercion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Parameter Validation and Coercion</h2>

<p>You can define validations and coercion options for your parameters using a <code>params</code> block.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">requires</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">optional</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">regexp</span><span class="p">:</span> <span class="sr">/^[a-z]+$/</span>
  <span class="n">group</span> <span class="ss">:media</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:url</span>
  <span class="k">end</span>
  <span class="n">optional</span> <span class="ss">:audio</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Symbol</span><span class="p">,</span> <span class="ss">values</span><span class="p">:</span> <span class="o">[</span><span class="ss">:mp3</span><span class="p">,</span> <span class="ss">:wav</span><span class="p">,</span> <span class="ss">:aac</span><span class="p">,</span> <span class="ss">:ogg</span><span class="o">]</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="ss">:mp3</span>
  <span class="k">end</span>
  <span class="n">mutually_exclusive</span> <span class="ss">:media</span><span class="p">,</span> <span class="ss">:audio</span>
<span class="k">end</span>
<span class="n">put</span> <span class="s1">':id'</span> <span class="k">do</span>
  <span class="c1"># params[:id] is an Integer</span>
<span class="k">end</span>
</pre></div>

<p>When a type is specified an implicit validation is done after the coercion to ensure
the output type is the one declared.</p>

<p>Optional parameters can have a default value.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:color</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s1">'blue'</span>
  <span class="n">optional</span> <span class="ss">:random_number</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">Random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">100</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">optional</span> <span class="ss">:non_random_number</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span>  <span class="no">Random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">100</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<p>Parameters can be restricted to a specific set of values with the <code>:values</code> option.</p>

<p>Default values are eagerly evaluated. Above <code>:non_random_number</code> will evaluate to the same
number for each call to the endpoint of this <code>params</code> block. To have the default evaluate
at calltime use a lambda, like <code>:random_number</code> above.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">requires</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Symbol</span><span class="p">,</span> <span class="ss">values</span><span class="p">:</span> <span class="o">[</span><span class="ss">:not_started</span><span class="p">,</span> <span class="ss">:processing</span><span class="p">,</span> <span class="ss">:done</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<p>The <code>:values</code> option can also be supplied with a <code>Proc</code> to be evalutated at runtime. For example, given a status
model you may want to restrict by hashtags that you have previously defined in the <code>HashTag</code> model.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">requires</span> <span class="ss">:hashtag</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">values</span><span class="p">:</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">Hashtag</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:tag</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>

<p>Parameters can be nested using <code>group</code> or by calling <code>requires</code> or <code>optional</code> with a block.
In the above example, this means <code>params[:media][:url]</code> is required along with <code>params[:id]</code>,
and <code>params[:audio][:format]</code> is required only if <code>params[:audio]</code> is present.
With a block, <code>group</code>, <code>requires</code> and <code>optional</code> accept an additional option <code>type</code> which can
be either <code>Array</code> or <code>Hash</code>, and defaults to <code>Array</code>. Depending on the value, the nested
parameters will be treated either as values of a hash or as values of hashes in an array.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:preferences</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:key</span>
    <span class="n">requires</span> <span class="ss">:value</span>
  <span class="k">end</span>

  <span class="n">requires</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:first_name</span>
    <span class="n">requires</span> <span class="ss">:last_name</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Parameters can be defined as <code>mutually_exclusive</code>, ensuring that they aren't present at the same time in a request.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:beer</span>
  <span class="n">optional</span> <span class="ss">:wine</span>
  <span class="n">mutually_exclusive</span> <span class="ss">:beer</span><span class="p">,</span> <span class="ss">:wine</span>
<span class="k">end</span>
</pre></div>

<p>Multiple sets can be defined:</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:beer</span>
  <span class="n">optional</span> <span class="ss">:wine</span>
  <span class="n">mutually_exclusive</span> <span class="ss">:beer</span><span class="p">,</span> <span class="ss">:wine</span>
  <span class="n">optional</span> <span class="ss">:scotch</span>
  <span class="n">optional</span> <span class="ss">:aquavit</span>
  <span class="n">mutually_exclusive</span> <span class="ss">:scotch</span><span class="p">,</span> <span class="ss">:aquavit</span>
<span class="k">end</span>
</pre></div>

<p><strong>Warning</strong>: Never define mutually exclusive sets with any required params. Two mutually exclusive required params will mean params are never valid, thus making the endpoint useless. One required param mutually exclusive with an optional param will mean the latter is never valid.</p>

<p>Parameters can be defined as 'exactly_one_of', ensuring that exactly one parameter gets selected.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:beer</span>
  <span class="n">optional</span> <span class="ss">:wine</span>
  <span class="n">exactly_one_of</span> <span class="ss">:beer</span><span class="p">,</span> <span class="ss">:wine</span>
<span class="k">end</span>
</pre></div>

<p>Parameters can be defined as 'at_least_one_of', ensuring that at least one parameter gets selected.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:beer</span>
  <span class="n">optional</span> <span class="ss">:wine</span>
  <span class="n">optional</span> <span class="ss">:juice</span>
  <span class="n">at_least_one</span> <span class="ss">:beer</span><span class="p">,</span> <span class="ss">:wine</span><span class="p">,</span> <span class="ss">:juice</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-namespace-validation-and-coercion" class="anchor" href="#namespace-validation-and-coercion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Namespace Validation and Coercion</h3>

<p>Namespaces allow parameter definitions and apply to every method within the namespace.</p>

<div class="highlight highlight-ruby"><pre><span class="n">namespace</span> <span class="ss">:statuses</span> <span class="k">do</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"A user ID."</span>
  <span class="k">end</span>
  <span class="n">namespace</span> <span class="s2">":user_id"</span> <span class="k">do</span>
    <span class="n">desc</span> <span class="s2">"Retrieve a user's status."</span>
    <span class="n">params</span> <span class="k">do</span>
      <span class="n">requires</span> <span class="ss">:status_id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"A status ID."</span>
    <span class="k">end</span>
    <span class="n">get</span> <span class="s2">":status_id"</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:status_id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The <code>namespace</code> method has a number of aliases, including: <code>group</code>, <code>resource</code>,
<code>resources</code>, and <code>segment</code>. Use whichever reads the best for your API.</p>

<p>You can conveniently define a route parameter as a namespace using <code>route_param</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="n">namespace</span> <span class="ss">:statuses</span> <span class="k">do</span>
  <span class="n">route_param</span> <span class="ss">:id</span> <span class="k">do</span>
    <span class="n">desc</span> <span class="s2">"Returns all replies for a status."</span>
    <span class="n">get</span> <span class="s1">'replies'</span> <span class="k">do</span>
      <span class="no">Status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">replies</span>
    <span class="k">end</span>
    <span class="n">desc</span> <span class="s2">"Returns a status."</span>
    <span class="n">get</span> <span class="k">do</span>
      <span class="no">Status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-custom-validators" class="anchor" href="#custom-validators" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Validators</h3>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">AlphaNumeric</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Validations</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate_param!</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="n">attr_name</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/^[[:alnum:]]+$/</span>
      <span class="k">raise</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Exceptions</span><span class="o">::</span><span class="no">Validation</span><span class="p">,</span> <span class="ss">param</span><span class="p">:</span> <span class="vi">@scope</span><span class="o">.</span><span class="n">full_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="ss">message</span><span class="p">:</span> <span class="s2">"must consist of alpha-numeric characters"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">requires</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">alpha_numeric</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>

<p>You can also create custom classes that take parameters.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Length</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Validations</span><span class="o">::</span><span class="no">SingleOptionValidator</span>
  <span class="k">def</span> <span class="nf">validate_param!</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="n">attr_name</span><span class="o">].</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="vi">@option</span>
      <span class="k">raise</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Exceptions</span><span class="o">::</span><span class="no">Validation</span><span class="p">,</span> <span class="ss">param</span><span class="p">:</span> <span class="vi">@scope</span><span class="o">.</span><span class="n">full_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="ss">message</span><span class="p">:</span> <span class="s2">"must be at the most </span><span class="si">#{</span><span class="vi">@option</span><span class="si">}</span><span class="s2"> characters long"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">requires</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="mi">140</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-validation-errors" class="anchor" href="#validation-errors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Validation Errors</h3>

<p>Validation and coercion errors are collected and an exception of type <code>Grape::Exceptions::ValidationErrors</code> is raised. If the exception goes uncaught it will respond with a status of 400 and an error message. The validation errors are grouped by parameter name and can be accessed via <code>Grape::Exceptions::ValidationErrors#errors</code>.</p>

<p>The default response from a <code>Grape::Exceptions::ValidationErrors</code> is a humanly readable string, such as "beer, wine are mutually exclusive", in the following example.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:beer</span>
  <span class="n">optional</span> <span class="ss">:wine</span>
  <span class="n">optional</span> <span class="ss">:juice</span>
  <span class="n">exactly_one_of</span> <span class="ss">:beer</span><span class="p">,</span> <span class="ss">:wine</span><span class="p">,</span> <span class="ss">:juice</span>
<span class="k">end</span>
</pre></div>

<p>You can rescue a <code>Grape::Exceptions::ValidationErrors</code> and respond with a custom response or turn the response into well-formatted JSON for a JSON API that separates individual parameters and the corresponding error messages. The following <code>rescue_from</code> example produces <code>[{"params":["beer","wine"],"messages":["are mutually exclusive"]}]</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="nb">format</span> <span class="ss">:json</span>
<span class="n">subject</span><span class="o">.</span><span class="n">rescue_from</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Exceptions</span><span class="o">::</span><span class="no">ValidationErrors</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
  <span class="n">rack_response</span> <span class="n">e</span><span class="o">.</span><span class="n">to_json</span><span class="p">,</span> <span class="mi">400</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-i18n" class="anchor" href="#i18n" aria-hidden="true"><span class="octicon octicon-link"></span></a>I18n</h3>

<p>Grape supports I18n for parameter-related error messages, but will fallback to English if
translations for the default locale have not been provided. See <a href="lib/grape/locale/en.yml">en.yml</a> for message keys.</p>

<h2>
<a name="user-content-headers" class="anchor" href="#headers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Headers</h2>

<p>Request headers are available through the <code>headers</code> helper or from <code>env</code> in their original form.</p>

<div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="k">do</span>
  <span class="n">error!</span><span class="p">(</span><span class="s1">'Unauthorized'</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span> <span class="k">unless</span> <span class="n">headers</span><span class="o">[</span><span class="s1">'Secret-Password'</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'swordfish'</span>
<span class="k">end</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="k">do</span>
  <span class="n">error!</span><span class="p">(</span><span class="s1">'Unauthorized'</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span> <span class="k">unless</span> <span class="n">env</span><span class="o">[</span><span class="s1">'HTTP_SECRET_PASSWORD'</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'swordfish'</span>
<span class="k">end</span>
</pre></div>

<p>You can set a response header with <code>header</code> inside an API.</p>

<div class="highlight highlight-ruby"><pre><span class="n">header</span> <span class="s1">'X-Robots-Tag'</span><span class="p">,</span> <span class="s1">'noindex'</span>
</pre></div>

<p>When raising <code>error!</code>, pass additional headers as arguments.</p>

<div class="highlight highlight-ruby"><pre><span class="n">error!</span> <span class="s1">'Unauthorized'</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'X-Error-Detail'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid token.'</span>
</pre></div>

<h2>
<a name="user-content-routes" class="anchor" href="#routes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Routes</h2>

<p>Optionally, you can define requirements for your named route parameters using regular
expressions on namespace or endpoint. The route will match only if all requirements are met.</p>

<div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">':id'</span><span class="p">,</span> <span class="ss">requirements</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="sr">/[0-9]*/</span> <span class="p">}</span> <span class="k">do</span>
  <span class="no">Status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">namespace</span> <span class="ss">:outer</span><span class="p">,</span> <span class="ss">requirements</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="sr">/[0-9]*/</span> <span class="p">}</span> <span class="k">do</span>
  <span class="n">get</span> <span class="ss">:id</span> <span class="k">do</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">":id/edit"</span> <span class="k">do</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-helpers" class="anchor" href="#helpers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Helpers</h2>

<p>You can define helper methods that your endpoints can use with the <code>helpers</code>
macro by either giving a block or a module.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">StatusHelpers</span>
  <span class="k">def</span> <span class="nf">user_info</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2"> has statused </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">statuses</span><span class="si">}</span><span class="s2"> status(s)"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># define helpers with a block</span>
  <span class="n">helpers</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">current_user</span>
      <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># or mix in a module</span>
  <span class="n">helpers</span> <span class="no">StatusHelpers</span>

  <span class="n">get</span> <span class="s1">'info'</span> <span class="k">do</span>
    <span class="c1"># helpers available in your endpoint and filters</span>
    <span class="n">user_info</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can define reusable <code>params</code> using <code>helpers</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">helpers</span> <span class="k">do</span>
    <span class="n">params</span> <span class="ss">:pagination</span> <span class="k">do</span>
      <span class="n">optional</span> <span class="ss">:page</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
      <span class="n">optional</span> <span class="ss">:per_page</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">"Get collection"</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">use</span> <span class="ss">:pagination</span> <span class="c1"># aliases: includes, use_scope</span>
  <span class="k">end</span>
  <span class="n">get</span> <span class="k">do</span>
    <span class="no">Collection</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">per</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can also define reusable <code>params</code> using shared helpers.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">SharedParams</span>
  <span class="kp">extend</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="n">params</span> <span class="ss">:period</span> <span class="k">do</span>
    <span class="n">optional</span> <span class="ss">:start_date</span>
    <span class="n">optional</span> <span class="ss">:end_date</span>
  <span class="k">end</span>

  <span class="n">params</span> <span class="ss">:pagination</span> <span class="k">do</span>
    <span class="n">optional</span> <span class="ss">:page</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
    <span class="n">optional</span> <span class="ss">:per_page</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">helpers</span> <span class="no">SharedParams</span>

  <span class="n">desc</span> <span class="s2">"Get collection."</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">use</span> <span class="ss">:period</span><span class="p">,</span> <span class="ss">:pagination</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="k">do</span>
    <span class="no">Collection</span>
      <span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:start_date</span><span class="o">]</span><span class="p">)</span>
      <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:end_date</span><span class="o">]</span><span class="p">)</span>
      <span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
      <span class="o">.</span><span class="n">per</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Helpers support blocks that can help set default values. The following API can return a collection sorted by <code>id</code> or <code>created_at</code> in <code>asc</code> or <code>desc</code> order.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">SharedParams</span>
  <span class="kp">extend</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span><span class="o">::</span><span class="no">Helpers</span>

  <span class="n">params</span> <span class="ss">:order</span> <span class="k">do</span> <span class="o">|</span><span class="n">options</span><span class="o">|</span>
    <span class="n">optional</span> <span class="ss">:order_by</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span><span class="no">Symbol</span><span class="p">,</span> <span class="ss">values</span><span class="p">:</span><span class="n">options</span><span class="o">[</span><span class="ss">:order_by</span><span class="o">]</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span><span class="n">options</span><span class="o">[</span><span class="ss">:default_order_by</span><span class="o">]</span>
    <span class="n">optional</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span><span class="no">Symbol</span><span class="p">,</span> <span class="ss">values</span><span class="p">:</span><span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="n">asc</span> <span class="n">desc</span><span class="p">),</span> <span class="ss">default</span><span class="p">:</span><span class="n">options</span><span class="o">[</span><span class="ss">:default_order</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">helpers</span> <span class="no">SharedParams</span>

  <span class="n">desc</span> <span class="s2">"Get a sorted collection."</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">use</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">order_by</span><span class="p">:</span><span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="nb">id</span> <span class="n">created_at</span><span class="p">),</span> <span class="ss">default_order_by</span><span class="p">:</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">default_order</span><span class="p">:</span> <span class="ss">:asc</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="k">do</span>
    <span class="no">Collection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:order</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:order_by</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-parameter-documentation" class="anchor" href="#parameter-documentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Parameter Documentation</h2>

<p>You can attach additional documentation to <code>params</code> using a <code>documentation</code> hash.</p>

<div class="highlight highlight-ruby"><pre><span class="n">params</span> <span class="k">do</span>
  <span class="n">optional</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">documentation</span><span class="p">:</span> <span class="p">{</span> <span class="ss">example</span><span class="p">:</span> <span class="s1">'Jim'</span> <span class="p">}</span>
  <span class="n">requires</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">documentation</span><span class="p">:</span> <span class="p">{</span> <span class="ss">example</span><span class="p">:</span> <span class="s1">'Smith'</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-cookies" class="anchor" href="#cookies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cookies</h2>

<p>You can set, get and delete your cookies very simply using <code>cookies</code> method.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">get</span> <span class="s1">'status_count'</span> <span class="k">do</span>
    <span class="n">cookies</span><span class="o">[</span><span class="ss">:status_count</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span>
    <span class="n">cookies</span><span class="o">[</span><span class="ss">:status_count</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">{</span> <span class="ss">status_count</span><span class="p">:</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:status_count</span><span class="o">]</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">delete</span> <span class="s1">'status_count'</span> <span class="k">do</span>
    <span class="p">{</span> <span class="ss">status_count</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:status_count</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Use a hash-based syntax to set more than one value.</p>

<div class="highlight highlight-ruby"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:status_count</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">value</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="ss">expires</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">tomorrow</span><span class="p">,</span>
  <span class="ss">domain</span><span class="p">:</span> <span class="s1">'.twitter.com'</span><span class="p">,</span>
  <span class="ss">path</span><span class="p">:</span> <span class="s1">'/'</span>
<span class="p">}</span>

<span class="n">cookies</span><span class="o">[</span><span class="ss">:status_count</span><span class="o">][</span><span class="ss">:value</span><span class="o">]</span> <span class="o">+=</span><span class="mi">1</span>
</pre></div>

<p>Delete a cookie with <code>delete</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">delete</span> <span class="ss">:status_count</span>
</pre></div>

<p>Specify an optional path.</p>

<div class="highlight highlight-ruby"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">delete</span> <span class="ss">:status_count</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">'/'</span>
</pre></div>

<h2>
<a name="user-content-redirecting" class="anchor" href="#redirecting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Redirecting</h2>

<p>You can redirect to a new url temporarily (302) or permanently (301).</p>

<div class="highlight highlight-ruby"><pre><span class="n">redirect</span> <span class="s1">'/statuses'</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">redirect</span> <span class="s1">'/statuses'</span><span class="p">,</span> <span class="ss">permanent</span><span class="p">:</span> <span class="kp">true</span>
</pre></div>

<h2>
<a name="user-content-allowed-methods" class="anchor" href="#allowed-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Allowed Methods</h2>

<p>When you add a <code>GET</code> route for a resource, a route for the <code>HEAD</code>
method will also be added automatically. You can disable this
behavior with <code>do_not_route_head!</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">do_not_route_head!</span>

  <span class="n">get</span> <span class="s1">'/example'</span> <span class="k">do</span>
    <span class="c1"># only responds to GET</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>When you add a route for a resource, a route for the <code>OPTIONS</code>
method will also be added. The response to an OPTIONS request will
include an "Allow" header listing the supported methods.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">get</span> <span class="s1">'/rt_count'</span> <span class="k">do</span>
    <span class="p">{</span> <span class="ss">rt_count</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">rt_count</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">params</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:value</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s1">'Value to add to the rt count.'</span>
  <span class="k">end</span>
  <span class="n">put</span> <span class="s1">'/rt_count'</span> <span class="k">do</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">rt_count</span> <span class="o">+=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">to_i</span>
    <span class="p">{</span> <span class="ss">rt_count</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">rt_count</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<pre lang="shell"><code>curl -v -X OPTIONS http://localhost:3000/rt_count

&gt; OPTIONS /rt_count HTTP/1.1
&gt;
&lt; HTTP/1.1 204 No Content
&lt; Allow: OPTIONS, GET, PUT
</code></pre>

<p>You can disable this behavior with <code>do_not_route_options!</code>.</p>

<p>If a request for a resource is made with an unsupported HTTP method, an
HTTP 405 (Method Not Allowed) response will be returned.</p>

<pre lang="shell"><code>curl -X DELETE -v http://localhost:3000/rt_count/

&gt; DELETE /rt_count/ HTTP/1.1
&gt; Host: localhost:3000
&gt;
&lt; HTTP/1.1 405 Method Not Allowed
&lt; Allow: OPTIONS, GET, PUT
</code></pre>

<h2>
<a name="user-content-raising-exceptions" class="anchor" href="#raising-exceptions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Raising Exceptions</h2>

<p>You can abort the execution of an API method by raising errors with <code>error!</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="n">error!</span> <span class="s1">'Access Denied'</span><span class="p">,</span> <span class="mi">401</span>
</pre></div>

<p>You can also return JSON formatted objects by raising error! and passing a hash
instead of a message.</p>

<div class="highlight highlight-ruby"><pre><span class="n">error!</span><span class="p">({</span> <span class="ss">error</span><span class="p">:</span> <span class="s2">"unexpected error"</span><span class="p">,</span> <span class="ss">detail</span><span class="p">:</span> <span class="s2">"missing widget"</span> <span class="p">},</span> <span class="mi">500</span><span class="p">)</span>
</pre></div>

<p>You can present documented errors with a Grape entity using the the <a href="https://github.com/intridea/grape-entity">grape-entity</a> gem.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">API</span>
  <span class="k">class</span> <span class="nc">Error</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Entity</span>
    <span class="n">expose</span> <span class="ss">:code</span>
    <span class="n">expose</span> <span class="ss">:message</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The following example specifies the entity to use in the <code>http_codes</code> definition.</p>

<pre><code>desc 'My Route', http_codes: [[408, 'Unauthorized', API::Error]]
error!({ message: 'Unauthorized' }, 408)
</code></pre>

<p>The following example specifies the presented entity explicitly in the error message.</p>

<div class="highlight highlight-ruby"><pre><span class="n">desc</span> <span class="s1">'My Route'</span><span class="p">,</span> <span class="ss">http_codes</span><span class="p">:</span> <span class="o">[[</span><span class="mi">408</span><span class="p">,</span> <span class="s1">'Unauthorized'</span><span class="o">]]</span>
<span class="n">error!</span><span class="p">({</span> <span class="ss">message</span><span class="p">:</span> <span class="s1">'Unauthorized'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="no">API</span><span class="o">::</span><span class="no">Error</span> <span class="p">},</span> <span class="mi">408</span><span class="p">)</span>
</pre></div>

<h3>
<a name="user-content-default-error-http-status-code" class="anchor" href="#default-error-http-status-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Default Error HTTP Status Code</h3>

<p>By default Grape returns a 500 status code from <code>error!</code>. You can change this with <code>default_error_status</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">default_error_status</span> <span class="mi">400</span>
  <span class="n">get</span> <span class="s1">'/example'</span> <span class="k">do</span>
    <span class="n">error!</span> <span class="s2">"This should have http status code 400"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-handling-404" class="anchor" href="#handling-404" aria-hidden="true"><span class="octicon octicon-link"></span></a>Handling 404</h3>

<p>For Grape to handle all the 404s for your API, it can be useful to use a catch-all.
In its simplest form, it can be like:</p>

<div class="highlight highlight-ruby"><pre><span class="n">route</span> <span class="ss">:any</span><span class="p">,</span> <span class="s1">'*path'</span> <span class="k">do</span>
  <span class="n">error!</span> <span class="c1"># or something else</span>
<span class="k">end</span>
</pre></div>

<p>It is very crucial to <strong>define this endpoint at the very end of your API</strong>, as it
literally accepts every request.</p>

<h2>
<a name="user-content-exception-handling" class="anchor" href="#exception-handling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exception Handling</h2>

<p>Grape can be told to rescue all exceptions and return them in the API format.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">rescue_from</span> <span class="ss">:all</span>
<span class="k">end</span>
</pre></div>

<p>You can also rescue specific exceptions.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">rescue_from</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="no">UserDefinedError</span>
<span class="k">end</span>
</pre></div>

<p>In this case <code>UserDefinedError</code> must be inherited from <code>StandardError</code>.</p>

<p>The error format will match the request format. See "Content-Types" below.</p>

<p>Custom error formatters for existing and additional types can be defined with a proc.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">error_formatter</span> <span class="ss">:txt</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">message</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">env</span><span class="o">|</span>
    <span class="s2">"error: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2"> from </span><span class="si">#{</span><span class="n">backtrace</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div>

<p>You can also use a module or class.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">CustomFormatter</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">message</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="ss">backtrace</span><span class="p">:</span> <span class="n">backtrace</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">error_formatter</span> <span class="ss">:custom</span><span class="p">,</span> <span class="no">CustomFormatter</span>
<span class="k">end</span>
</pre></div>

<p>You can rescue all exceptions with a code block. The <code>error_response</code> wrapper
automatically sets the default error code and content-type.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">rescue_from</span> <span class="ss">:all</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="n">error_response</span><span class="p">({</span> <span class="ss">message</span><span class="p">:</span> <span class="s2">"rescued from </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span> <span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can also rescue specific exceptions with a code block and handle the Rack
response at the lowest level.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">rescue_from</span> <span class="ss">:all</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="o">]</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="p">{</span> <span class="s2">"Content-type"</span> <span class="o">=&gt;</span> <span class="s2">"text/error"</span> <span class="p">})</span><span class="o">.</span><span class="n">finish</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Or rescue specific exceptions.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">rescue_from</span> <span class="no">ArgumentError</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s2">"ArgumentError: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">finish</span>
  <span class="k">end</span>
  <span class="n">rescue_from</span> <span class="no">NotImplementedError</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s2">"NotImplementedError: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">finish</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>By default, <code>rescue_from</code> will rescue the exceptions listed and all their subclasses.</p>

<p>Assume you have the following exception classes defined.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">APIErrors</span>
  <span class="k">class</span> <span class="nc">ParentError</span> <span class="o">&lt;</span> <span class="no">StandardError</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">class</span> <span class="nc">ChildError</span> <span class="o">&lt;</span> <span class="no">ParentError</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Then the following <code>rescue_from</code> clause will rescue exceptions of type <code>APIErrors::ParentError</code> and its subclasses (in this case <code>APIErrors::ChildError</code>).</p>

<div class="highlight highlight-ruby"><pre><span class="n">rescue_from</span> <span class="no">APIErrors</span><span class="o">::</span><span class="no">ParentError</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
      <span class="ss">error</span><span class="p">:</span> <span class="s2">"</span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2"> error"</span><span class="p">,</span>
      <span class="ss">message</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
      <span class="p">}</span><span class="o">.</span><span class="n">to_json</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">finish</span>
<span class="k">end</span>
</pre></div>

<p>To only rescue the base exception class, set <code>rescue_subclasses: false</code>.
The code below will rescue exceptions of type <code>RuntimeError</code> but <em>not</em> its subclasses.</p>

<div class="highlight highlight-ruby"><pre><span class="n">rescue_from</span> <span class="no">RuntimeError</span><span class="p">,</span> <span class="ss">rescue_subclasses</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
    <span class="no">Rack</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
      <span class="ss">status</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
      <span class="ss">message</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
      <span class="ss">errors</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span>
      <span class="p">}</span><span class="o">.</span><span class="n">to_json</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">finish</span>
<span class="k">end</span>
</pre></div>

<h4>
<a name="user-content-rails-3x" class="anchor" href="#rails-3x" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rails 3.x</h4>

<p>When mounted inside containers, such as Rails 3.x, errors like "404 Not Found" or
"406 Not Acceptable" will likely be handled and rendered by Rails handlers. For instance,
accessing a nonexistent route "/api/foo" raises a 404, which inside rails will ultimately
be translated to an <code>ActionController::RoutingError</code>, which most likely will get rendered
to a HTML error page.</p>

<p>Most APIs will enjoy preventing downstream handlers from handling errors. You may set the
<code>:cascade</code> option to <code>false</code> for the entire API or separately on specific <code>version</code> definitions,
which will remove the <code>X-Cascade: true</code> header from API responses.</p>

<div class="highlight highlight-ruby"><pre><span class="n">cascade</span> <span class="kp">false</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">version</span> <span class="s1">'v1'</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="ss">:header</span><span class="p">,</span> <span class="ss">vendor</span><span class="p">:</span> <span class="s1">'twitter'</span><span class="p">,</span> <span class="ss">cascade</span><span class="p">:</span> <span class="kp">false</span>
</pre></div>

<h2>
<a name="user-content-logging" class="anchor" href="#logging" aria-hidden="true"><span class="octicon octicon-link"></span></a>Logging</h2>

<p><code>Grape::API</code> provides a <code>logger</code> method which by default will return an instance of the <code>Logger</code>
class from Ruby's standard library.</p>

<p>To log messages from within an endpoint, you need to define a helper to make the logger
available in the endpoint context.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">helpers</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">logger</span>
      <span class="no">API</span><span class="o">.</span><span class="n">logger</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">post</span> <span class="s1">'/statuses'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">"</span><span class="si">#{</span><span class="n">current_user</span><span class="si">}</span><span class="s2"> has statused"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can also set your own logger.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">MyLogger</span>
  <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"this is a warning: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">logger</span> <span class="no">MyLogger</span><span class="o">.</span><span class="n">new</span>
  <span class="n">helpers</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">logger</span>
      <span class="no">API</span><span class="o">.</span><span class="n">logger</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">get</span> <span class="s1">'/statuses'</span> <span class="k">do</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span> <span class="s2">"</span><span class="si">#{</span><span class="n">current_user</span><span class="si">}</span><span class="s2"> has statused"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-api-formats" class="anchor" href="#api-formats" aria-hidden="true"><span class="octicon octicon-link"></span></a>API Formats</h2>

<p>By default, Grape supports <em>XML</em>, <em>JSON</em>, and <em>TXT</em> content-types. The default format is <code>:txt</code>.</p>

<p>Serialization takes place automatically. For example, you do not have to call <code>to_json</code> in each JSON API implementation.</p>

<p>Your API can declare which types to support by using <code>content_type</code>. Response format is determined by the
request's extension, an explicit <code>format</code> parameter in the query string, or <code>Accept</code> header.</p>

<p>The following API will only respond to the JSON content-type and will not parse any other input than <code>application/json</code>,
<code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code>, <code>multipart/related</code> and <code>multipart/mixed</code>. All other requests
will fail with an HTTP 406 error code.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="nb">format</span> <span class="ss">:json</span>
<span class="k">end</span>
</pre></div>

<p>When the content-type is omitted, Grape will return a 406 error code unless <code>default_format</code> is specified.
The following API will try to parse any data without a content-type using a JSON parser.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="nb">format</span> <span class="ss">:json</span>
  <span class="n">default_format</span> <span class="ss">:json</span>
<span class="k">end</span>
</pre></div>

<p>If you combine <code>format</code> with <code>rescue_from :all</code>, errors will be rendered using the same format.
If you do not want this behavior, set the default error formatter with <code>default_error_formatter</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="nb">format</span> <span class="ss">:json</span>
  <span class="n">content_type</span> <span class="ss">:txt</span><span class="p">,</span> <span class="s2">"text/plain"</span>
  <span class="n">default_error_formatter</span> <span class="ss">:txt</span>
<span class="k">end</span>
</pre></div>

<p>Custom formatters for existing and additional types can be defined with a proc.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">content_type</span> <span class="ss">:xls</span><span class="p">,</span> <span class="s2">"application/vnd.ms-excel"</span>
  <span class="n">formatter</span> <span class="ss">:xls</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="p">,</span> <span class="n">env</span><span class="o">|</span> <span class="n">object</span><span class="o">.</span><span class="n">to_xls</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>

<p>You can also use a module or class.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">XlsFormatter</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">object</span><span class="o">.</span><span class="n">to_xls</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">content_type</span> <span class="ss">:xls</span><span class="p">,</span> <span class="s2">"application/vnd.ms-excel"</span>
  <span class="n">formatter</span> <span class="ss">:xls</span><span class="p">,</span> <span class="no">XlsFormatter</span>
<span class="k">end</span>
</pre></div>

<p>Built-in formats are the following.</p>

<ul class="task-list">
<li>
<code>:json</code> and <code>:jsonapi</code>: use object's <code>to_json</code> when available, otherwise call <code>MultiJson.dump</code>
</li>
<li>
<code>:xml</code>: use object's <code>to_xml</code> when available, usually via <code>MultiXml</code>, otherwise call <code>to_s</code>
</li>
<li>
<code>:txt</code>: use object's <code>to_txt</code> when available, otherwise <code>to_s</code>
</li>
<li>
<code>:serializable_hash</code>: use object's <code>serializable_hash</code> when available, otherwise fallback to <code>:json</code>
</li>
</ul><p>Use <code>default_format</code> to set the fallback format when the format could not be determined from the <code>Accept</code> header.
See below for the order for choosing the API format.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">default_format</span> <span class="ss">:json</span>
<span class="k">end</span>
</pre></div>

<p>The order for choosing the format is the following.</p>

<ul class="task-list">
<li>Use the file extension, if specified. If the file is .json, choose the JSON format.</li>
<li>Use the value of the <code>format</code> parameter in the query string, if specified.</li>
<li>Use the format set by the <code>format</code> option, if specified.</li>
<li>Attempt to find an acceptable format from the <code>Accept</code> header.</li>
<li>Use the default format, if specified by the <code>default_format</code> option.</li>
<li>Default to <code>:txt</code>.</li>
</ul><p>You can override this process explicitly by specifying <code>env['api.format']</code> in the API itself.
For example, the following API will let you upload arbitrary files and return their contents as an attachment with the correct MIME type.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">post</span> <span class="s2">"attachment"</span> <span class="k">do</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:file</span><span class="o">][</span><span class="ss">:filename</span><span class="o">]</span>
    <span class="n">content_type</span> <span class="no">MIME</span><span class="o">::</span><span class="no">Types</span><span class="o">.</span><span class="n">type_for</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_s</span>
    <span class="n">env</span><span class="o">[</span><span class="s1">'api.format'</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:binary</span> <span class="c1"># there's no formatter for :binary, data will be returned "as is"</span>
    <span class="n">header</span> <span class="s2">"Content-Disposition"</span><span class="p">,</span> <span class="s2">"attachment; filename*=UTF-8''</span><span class="si">#{</span><span class="no">URI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">params</span><span class="o">[</span><span class="ss">:file</span><span class="o">][</span><span class="ss">:tempfile</span><span class="o">].</span><span class="n">read</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-jsonp" class="anchor" href="#jsonp" aria-hidden="true"><span class="octicon octicon-link"></span></a>JSONP</h3>

<p>Grape supports JSONP via <a href="https://github.com/rack/rack-contrib">Rack::JSONP</a>, part of the
<a href="https://github.com/rack/rack-contrib">rack-contrib</a> gem. Add <code>rack-contrib</code> to your <code>Gemfile</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'rack/contrib'</span>

<span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">JSONP</span>
  <span class="nb">format</span> <span class="ss">:json</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Hello World'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-cors" class="anchor" href="#cors" aria-hidden="true"><span class="octicon octicon-link"></span></a>CORS</h3>

<p>Grape supports CORS via <a href="https://github.com/cyu/rack-cors">Rack::CORS</a>, part of the
<a href="https://github.com/cyu/rack-cors">rack-cors</a> gem. Add <code>rack-cors</code> to your <code>Gemfile</code>,
then use the middleware in your config.ru file.</p>

<div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'rack/cors'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cors</span> <span class="k">do</span>
  <span class="n">allow</span> <span class="k">do</span>
    <span class="n">origins</span> <span class="s1">'*'</span>
    <span class="n">resource</span> <span class="s1">'*'</span><span class="p">,</span> <span class="ss">headers</span><span class="p">:</span> <span class="ss">:any</span><span class="p">,</span> <span class="nb">methods</span><span class="p">:</span> <span class="ss">:get</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span>

</pre></div>

<h2>
<a name="user-content-content-type" class="anchor" href="#content-type" aria-hidden="true"><span class="octicon octicon-link"></span></a>Content-type</h2>

<p>Content-type is set by the formatter. You can override the content-type of the response at runtime
by setting the <code>Content-Type</code> header.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">get</span> <span class="s1">'/home_timeline_js'</span> <span class="k">do</span>
    <span class="n">content_type</span> <span class="s2">"application/javascript"</span>
    <span class="s2">"var statuses = ...;"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-api-data-formats" class="anchor" href="#api-data-formats" aria-hidden="true"><span class="octicon octicon-link"></span></a>API Data Formats</h2>

<p>Grape accepts and parses input data sent with the POST and PUT methods as described in the Parameters
section above. It also supports custom data formats. You must declare additional content-types via
<code>content_type</code> and optionally supply a parser via <code>parser</code> unless a parser is already available within
Grape to enable a custom format. Such a parser can be a function or a class.</p>

<p>With a parser, parsed data is available "as-is" in <code>env['api.request.body']</code>.
Without a parser, data is available "as-is" and in <code>env['api.request.input']</code>.</p>

<p>The following example is a trivial parser that will assign any input with the "text/custom" content-type
to <code>:value</code>. The parameter will be available via <code>params[:value]</code> inside the API call.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">CustomParser</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">value</span><span class="p">:</span> <span class="n">object</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">content_type</span> <span class="ss">:txt</span><span class="p">,</span> <span class="s2">"text/plain"</span>
<span class="n">content_type</span> <span class="ss">:custom</span><span class="p">,</span> <span class="s2">"text/custom"</span>
<span class="n">parser</span> <span class="ss">:custom</span><span class="p">,</span> <span class="no">CustomParser</span>

<span class="n">put</span> <span class="s2">"value"</span> <span class="k">do</span>
  <span class="n">params</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<p>You can invoke the above API as follows.</p>

<pre><code>curl -X PUT -d 'data' 'http://localhost:9292/value' -H Content-Type:text/custom -v
</code></pre>

<p>You can disable parsing for a content-type with <code>nil</code>. For example, <code>parser :json, nil</code> will disable JSON parsing altogether. The request data is then available as-is in <code>env['api.request.body']</code>.</p>

<h2>
<a name="user-content-restful-model-representations" class="anchor" href="#restful-model-representations" aria-hidden="true"><span class="octicon octicon-link"></span></a>RESTful Model Representations</h2>

<p>Grape supports a range of ways to present your data with some help from a generic <code>present</code> method,
which accepts two arguments: the object to be presented and the options associated with it. The options
hash may include <code>:with</code>, which defines the entity to expose.</p>

<h3>
<a name="user-content-grape-entities" class="anchor" href="#grape-entities" aria-hidden="true"><span class="octicon octicon-link"></span></a>Grape Entities</h3>

<p>Add the <a href="https://github.com/intridea/grape-entity">grape-entity</a> gem to your Gemfile.
Please refer to the <a href="https://github.com/intridea/grape-entity/blob/master/README.md">grape-entity documentation</a>
for more details.</p>

<p>The following example exposes statuses.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">API</span>
  <span class="k">module</span> <span class="nn">Entities</span>
    <span class="k">class</span> <span class="nc">Status</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Entity</span>
      <span class="n">expose</span> <span class="ss">:user_name</span>
      <span class="n">expose</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">documentation</span><span class="p">:</span> <span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Status update text."</span> <span class="p">}</span>
      <span class="n">expose</span> <span class="ss">:ip</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:full</span> <span class="p">}</span>
      <span class="n">expose</span> <span class="ss">:user_type</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">status</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span> <span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">public?</span> <span class="p">}</span>
      <span class="n">expose</span> <span class="ss">:digest</span> <span class="p">{</span> <span class="o">|</span><span class="n">status</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">txt</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">expose</span> <span class="ss">:replies</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="no">API</span><span class="o">::</span><span class="no">Status</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:replies</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Statuses</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
    <span class="n">version</span> <span class="s1">'v1'</span>

    <span class="n">desc</span> <span class="s1">'Statuses index'</span><span class="p">,</span> <span class="p">{</span>
      <span class="ss">params</span><span class="p">:</span> <span class="no">API</span><span class="o">::</span><span class="no">Entities</span><span class="o">::</span><span class="no">Status</span><span class="o">.</span><span class="n">documentation</span>
    <span class="p">}</span>
    <span class="n">get</span> <span class="s1">'/statuses'</span> <span class="k">do</span>
      <span class="n">statuses</span> <span class="o">=</span> <span class="no">Status</span><span class="o">.</span><span class="n">all</span>
      <span class="n">type</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="p">?</span> <span class="ss">:full</span> <span class="p">:</span> <span class="ss">:default</span>
      <span class="n">present</span> <span class="n">statuses</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="no">API</span><span class="o">::</span><span class="no">Entities</span><span class="o">::</span><span class="no">Status</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="n">type</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can use entity documentation directly in the params block with <code>using: Entity.documentation</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">API</span>
  <span class="k">class</span> <span class="nc">Statuses</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
    <span class="n">version</span> <span class="s1">'v1'</span>

    <span class="n">desc</span> <span class="s1">'Create a status'</span>
    <span class="n">params</span> <span class="k">do</span>
      <span class="n">requires</span> <span class="ss">:all</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span> <span class="o">[</span><span class="ss">:ip</span><span class="o">]</span><span class="p">,</span> <span class="ss">using</span><span class="p">:</span> <span class="no">API</span><span class="o">::</span><span class="no">Entities</span><span class="o">::</span><span class="no">Status</span><span class="o">.</span><span class="n">documentation</span><span class="o">.</span><span class="n">except</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">post</span> <span class="s1">'/status'</span> <span class="k">do</span>
      <span class="no">Status</span><span class="o">.</span><span class="n">create!</span> <span class="n">params</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>You can present with multiple entities using an optional Symbol argument.</p>

<div class="highlight highlight-ruby"><pre>  <span class="n">get</span> <span class="s1">'/statuses'</span> <span class="k">do</span>
    <span class="n">statuses</span> <span class="o">=</span> <span class="no">Status</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">per</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">present</span> <span class="ss">:total_page</span><span class="p">,</span> <span class="mi">10</span>
    <span class="n">present</span> <span class="ss">:per_page</span><span class="p">,</span> <span class="mi">20</span>
    <span class="n">present</span> <span class="ss">:statuses</span><span class="p">,</span> <span class="n">statuses</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="no">API</span><span class="o">::</span><span class="no">Entities</span><span class="o">::</span><span class="no">Status</span>
  <span class="k">end</span>
</pre></div>

<p>The response will be</p>

<pre><code>  {
    total_page: 10,
    per_page: 20,
    statuses: []
  }
</code></pre>

<p>In addition to separately organizing entities, it may be useful to put them as namespaced
classes underneath the model they represent.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Status</span>
  <span class="k">def</span> <span class="nf">entity</span>
    <span class="no">Entity</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Entity</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Entity</span>
    <span class="n">expose</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">:user_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>If you organize your entities this way, Grape will automatically detect the <code>Entity</code> class and
use it to present your models. In this example, if you added <code>present Status.new</code> to your endpoint,
Grape will automatically detect that there is a <code>Status::Entity</code> class and use that as the
representative entity. This can still be overridden by using the <code>:with</code> option or an explicit
<code>represents</code> call.</p>

<h3>
<a name="user-content-hypermedia-and-roar" class="anchor" href="#hypermedia-and-roar" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hypermedia and Roar</h3>

<p>You can use <a href="https://github.com/apotonick/roar">Roar</a> to render HAL or Collection+JSON with the help of <a href="https://github.com/dblock/grape-roar">grape-roar</a>, which defines a custom JSON formatter and enables presenting entities with Grape's <code>present</code> keyword.</p>

<h3>
<a name="user-content-rabl" class="anchor" href="#rabl" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rabl</h3>

<p>You can use <a href="https://github.com/nesquena/rabl">Rabl</a> templates with the help of the
<a href="https://github.com/LTe/grape-rabl">grape-rabl</a> gem, which defines a custom Grape Rabl
formatter.</p>

<h3>
<a name="user-content-active-model-serializers" class="anchor" href="#active-model-serializers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Active Model Serializers</h3>

<p>You can use <a href="https://github.com/rails-api/active_model_serializers">Active Model Serializers</a> serializers with the help of the
<a href="https://github.com/jrhe/grape-active_model_serializers">grape-active_model_serializers</a> gem, which defines a custom Grape AMS
formatter.</p>

<h2>
<a name="user-content-authentication" class="anchor" href="#authentication" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authentication</h2>

<h3>
<a name="user-content-basic-and-digest-auth" class="anchor" href="#basic-and-digest-auth" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic and Digest Auth</h3>

<p>Grape has built-in Basic and Digest authentication (the given <code>block</code>
is executed in the context of the current <code>Endpoint</code>).  Authentication
applies to the current namespace and any children, but not parents.</p>

<div class="highlight highlight-ruby"><pre><span class="n">http_basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">|</span>
  <span class="c1"># verify user's password here</span>
  <span class="p">{</span> <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="s1">'password1'</span> <span class="p">}</span><span class="o">[</span><span class="n">username</span><span class="o">]</span> <span class="o">==</span> <span class="n">password</span>
<span class="k">end</span>
</pre></div>

<div class="highlight highlight-ruby"><pre><span class="n">http_digest</span><span class="p">({</span> <span class="ss">realm</span><span class="p">:</span> <span class="s1">'Test Api'</span><span class="p">,</span> <span class="ss">opaque</span><span class="p">:</span> <span class="s1">'app secret'</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">username</span><span class="o">|</span>
  <span class="c1"># lookup the user's password here</span>
  <span class="p">{</span> <span class="s1">'user1'</span> <span class="o">=&gt;</span> <span class="s1">'password1'</span> <span class="p">}</span><span class="o">[</span><span class="n">username</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-register-custom-middleware-for-authentication" class="anchor" href="#register-custom-middleware-for-authentication" aria-hidden="true"><span class="octicon octicon-link"></span></a>Register custom middleware for authentication</h3>

<p>Grape can use custom Middleware for authentication. How to implement these
Middleware have a look at <code>Rack::Auth::Basic</code> or similar implementations.</p>

<p>For registering a Middlewar you need the following options:</p>

<ul class="task-list">
<li>
<code>label</code> - the name for your authenticator to use it later</li>
<li>
<code>MiddlewareClass</code> - the MiddlewareClass to use for authentication</li>
<li>
<code>option_lookup_proc</code> - A Proc with one Argument to lookup the options at
runtime (return value is an <code>Array</code> as Paramter for the Middleware).</li>
</ul><p>Example:</p>

<div class="highlight highlight-ruby"><pre>
<span class="no">Grape</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">Strategies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:my_auth</span><span class="p">,</span> <span class="no">AuthMiddleware</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span> <span class="o">[</span><span class="n">options</span><span class="o">[</span><span class="ss">:realm</span><span class="o">]]</span> <span class="p">}</span> <span class="p">)</span>


<span class="n">auth</span> <span class="ss">:my_auth</span> <span class="p">,{</span> <span class="ss">real</span><span class="p">:</span> <span class="s1">'Test Api'</span><span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">credentials</span><span class="o">|</span>
  <span class="c1"># lookup the user's password here</span>
  <span class="p">{</span> <span class="s1">'user1'</span> <span class="o">=&gt;</span> <span class="s1">'password1'</span> <span class="p">}</span><span class="o">[</span><span class="n">username</span><span class="o">]</span>
<span class="k">end</span>

</pre></div>

<p>Use <a href="https://github.com/opperator/warden-oauth2">warden-oauth2</a> or <a href="https://github.com/nov/rack-oauth2">rack-oauth2</a> for OAuth2 support.</p>

<h2>
<a name="user-content-describing-and-inspecting-an-api" class="anchor" href="#describing-and-inspecting-an-api" aria-hidden="true"><span class="octicon octicon-link"></span></a>Describing and Inspecting an API</h2>

<p>Grape routes can be reflected at runtime. This can notably be useful for generating
documentation.</p>

<p>Grape exposes arrays of API versions and compiled routes. Each route
contains a <code>route_prefix</code>, <code>route_version</code>, <code>route_namespace</code>, <code>route_method</code>,
<code>route_path</code> and <code>route_params</code>. The description and the optional hash that
follows the API path may contain any number of keys and its values are also
accessible via dynamically-generated <code>route_[name]</code> functions.</p>

<div class="highlight highlight-ruby"><pre><span class="no">TwitterAPI</span><span class="o">::</span><span class="n">versions</span> <span class="c1"># yields [ 'v1', 'v2' ]</span>
<span class="no">TwitterAPI</span><span class="o">::</span><span class="n">routes</span> <span class="c1"># yields an array of Grape::Route objects</span>
<span class="no">TwitterAPI</span><span class="o">::</span><span class="n">routes</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">route_version</span> <span class="c1"># yields 'v1'</span>
<span class="no">TwitterAPI</span><span class="o">::</span><span class="n">routes</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">route_description</span> <span class="c1"># etc.</span>
</pre></div>

<h2>
<a name="user-content-current-route-and-endpoint" class="anchor" href="#current-route-and-endpoint" aria-hidden="true"><span class="octicon octicon-link"></span></a>Current Route and Endpoint</h2>

<p>It's possible to retrieve the information about the current route from within an API
call with <code>route</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">MyAPI</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">desc</span> <span class="s2">"Returns a description of a parameter."</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s2">"Identity."</span>
  <span class="k">end</span>
  <span class="n">get</span> <span class="s2">"params/:id"</span> <span class="k">do</span>
    <span class="n">route</span><span class="o">.</span><span class="n">route_params</span><span class="o">[</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]]</span> <span class="c1"># yields the parameter description</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The current endpoint responding to the request is <code>self</code> within the API block
or <code>env['api.endpoint']</code> elsewhere. The endpoint has some interesting properties,
such as <code>source</code> which gives you access to the original code block of the API
implementation. This can be particularly useful for building a logger middleware.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">ApiLogger</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">before</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="s1">'api.endpoint'</span><span class="o">].</span><span class="n">source</span><span class="o">.</span><span class="n">source_location</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="s1">'api.endpoint'</span><span class="o">].</span><span class="n">source</span><span class="o">.</span><span class="n">source_location</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">"[api] </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-before-and-after" class="anchor" href="#before-and-after" aria-hidden="true"><span class="octicon octicon-link"></span></a>Before and After</h2>

<p>Blocks can be executed before or after every API call, using <code>before</code>, <code>after</code>,
<code>before_validation</code> and <code>after_validation</code>.</p>

<p>Before and after callbacks execute in the following order:</p>

<ol class="task-list">
<li><code>before</code></li>
<li><code>before_validation</code></li>
<li><em>validations</em></li>
<li><code>after_validation</code></li>
<li><em>the API call</em></li>
<li><code>after</code></li>
</ol><p>Steps 4, 5 and 6 only happen if validation succeeds.</p>

<p>E.g. using <code>before</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="n">before</span> <span class="k">do</span>
  <span class="n">header</span> <span class="s2">"X-Robots-Tag"</span><span class="p">,</span> <span class="s2">"noindex"</span>
<span class="k">end</span>
</pre></div>

<p>The block applies to every API call within and below the current namespace:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">MyAPI</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s2">"root - </span><span class="si">#{</span><span class="vi">@blah</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">namespace</span> <span class="ss">:foo</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@blah</span> <span class="o">=</span> <span class="s1">'blah'</span>
    <span class="k">end</span>

    <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
      <span class="s2">"root - foo - </span><span class="si">#{</span><span class="vi">@blah</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="n">namespace</span> <span class="ss">:bar</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
        <span class="s2">"root - foo - bar - </span><span class="si">#{</span><span class="vi">@blah</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The behaviour is then:</p>

<div class="highlight highlight-bash"><pre>GET /           <span class="c"># 'root - '</span>
GET /foo        <span class="c"># 'root - foo - blah'</span>
GET /foo/bar    <span class="c"># 'root - foo - bar - blah'</span>
</pre></div>

<p>Params on a <code>namespace</code> (or whatever alias you are using) also work when using
<code>before_validation</code> or <code>after_validation</code>:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">MyAPI</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">requires</span> <span class="ss">:blah</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="k">end</span>
  <span class="n">resource</span> <span class="s1">':blah'</span> <span class="k">do</span>
    <span class="n">after_validation</span> <span class="k">do</span>
      <span class="c1"># if we reach this point validations will have passed</span>
      <span class="vi">@blah</span> <span class="o">=</span> <span class="n">declared</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="ss">include_missing</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span><span class="o">[</span><span class="ss">:blah</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
      <span class="vi">@blah</span><span class="o">.</span><span class="n">class</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>The behaviour is then:</p>

<div class="highlight highlight-bash"><pre>GET /123        <span class="c"># 'Fixnum'</span>
GET /foo        <span class="c"># 400 error - 'blah is invalid'</span>
</pre></div>

<h2>
<a name="user-content-anchoring" class="anchor" href="#anchoring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Anchoring</h2>

<p>Grape by default anchors all request paths, which means that the request URL
should match from start to end to match, otherwise a <code>404 Not Found</code> is
returned. However, this is sometimes not what you want, because it is not always
known upfront what can be expected from the call. This is because Rack-mount by
default anchors requests to match from the start to the end, or not at all.
Rails solves this problem by using a <code>anchor: false</code> option in your routes.
In Grape this option can be used as well when a method is defined.</p>

<p>For instance when your API needs to get part of an URL, for instance:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">TwitterAPI</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
  <span class="n">namespace</span> <span class="ss">:statuses</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s1">'/(*:status)'</span><span class="p">,</span> <span class="ss">anchor</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>

    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>This will match all paths starting with '/statuses/'. There is one caveat though:
the <code>params[:status]</code> parameter only holds the first part of the request url.
Luckily this can be circumvented by using the described above syntax for path
specification and using the <code>PATH_INFO</code> Rack environment variable, using
<code>env["PATH_INFO"]</code>. This will hold everything that comes after the '/statuses/'
part.</p>

<h2>
<a name="user-content-writing-tests" class="anchor" href="#writing-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Writing Tests</h2>

<p>You can test a Grape API with RSpec by making HTTP requests and examining the response.</p>

<h3>
<a name="user-content-writing-tests-with-rack" class="anchor" href="#writing-tests-with-rack" aria-hidden="true"><span class="octicon octicon-link"></span></a>Writing Tests with Rack</h3>

<p>Use <code>rack-test</code> and define your API as <code>app</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="k">do</span>
    <span class="n">describe</span> <span class="s2">"GET /api/v1/statuses"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">"returns an empty array of statuses"</span> <span class="k">do</span>
        <span class="n">get</span> <span class="s2">"/api/v1/statuses"</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">last_response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">last_response</span><span class="o">.</span><span class="n">body</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[]</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">describe</span> <span class="s2">"GET /api/v1/statuses/:id"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">"returns a status by id"</span> <span class="k">do</span>
        <span class="n">status</span> <span class="o">=</span> <span class="no">Status</span><span class="o">.</span><span class="n">create!</span>
        <span class="n">get</span> <span class="s2">"/api/v1/statuses/</span><span class="si">#{</span><span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">last_response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">status</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-writing-tests-with-rails" class="anchor" href="#writing-tests-with-rails" aria-hidden="true"><span class="octicon octicon-link"></span></a>Writing Tests with Rails</h3>

<div class="highlight highlight-ruby"><pre><span class="n">describe</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">API</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"GET /api/v1/statuses"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"returns an empty array of statuses"</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s2">"/api/v1/statuses"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">describe</span> <span class="s2">"GET /api/v1/statuses/:id"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"returns a status by id"</span> <span class="k">do</span>
      <span class="n">status</span> <span class="o">=</span> <span class="no">Status</span><span class="o">.</span><span class="n">create!</span>
      <span class="n">get</span> <span class="s2">"/api/v1/statuses/</span><span class="si">#{</span><span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">status</span><span class="o">.</span><span class="n">to_json</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>In Rails, HTTP request tests would go into the <code>spec/requests</code> group. You may want your API code to go into
<code>app/api</code> - you can match that layout under <code>spec</code> by adding the following in <code>spec/spec_helper.rb</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">RSpec</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">RequestExampleGroup</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:request</span><span class="p">,</span> <span class="ss">example_group</span><span class="p">:</span> <span class="p">{</span>
    <span class="ss">file_path</span><span class="p">:</span> <span class="sr">/spec\/api/</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-stubbing-helpers" class="anchor" href="#stubbing-helpers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stubbing Helpers</h3>

<p>Because helpers are mixed in based on the context when an endpoint is defined, it can
be difficult to stub or mock them for testing. The <code>Grape::Endpoint.before_each</code> method
can help by allowing you to define behavior on the endpoint that will run before every
request.</p>

<div class="highlight highlight-ruby"><pre><span class="n">describe</span> <span class="s1">'an endpoint that needs helpers stubbed'</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="no">Grape</span><span class="o">::</span><span class="no">Endpoint</span><span class="o">.</span><span class="n">before_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">endpoint</span><span class="o">|</span>
      <span class="n">endpoint</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:helper_name</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s1">'desired_value'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">after</span> <span class="k">do</span>
    <span class="no">Grape</span><span class="o">::</span><span class="no">Endpoint</span><span class="o">.</span><span class="n">before_each</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'should properly stub the helper'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-reloading-api-changes-in-development" class="anchor" href="#reloading-api-changes-in-development" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reloading API Changes in Development</h2>

<h3>
<a name="user-content-rails-3x-1" class="anchor" href="#rails-3x-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rails 3.x</h3>

<p>Add API paths to <code>config/application.rb</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="c1"># Auto-load API and its subdirectories</span>
<span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">add</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"api"</span><span class="p">),</span> <span class="ss">glob</span><span class="p">:</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"**"</span><span class="p">,</span> <span class="s2">"*.rb"</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"api"</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">)</span><span class="o">]</span>
</pre></div>

<p>Create <code>config/initializers/reload_api.rb</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="o">.</span><span class="n">explicitly_unloadable_constants</span> <span class="o">&lt;&lt;</span> <span class="s2">"Twitter::API"</span>

  <span class="n">api_files</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="s1">'api'</span><span class="p">,</span> <span class="s1">'**'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)</span><span class="o">]</span>
  <span class="n">api_reloader</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">FileUpdateChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">api_files</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">reload_routes!</span>
  <span class="k">end</span>
  <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Callbacks</span><span class="o">.</span><span class="n">to_prepare</span> <span class="k">do</span>
    <span class="n">api_reloader</span><span class="o">.</span><span class="n">execute_if_updated</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>See <a href="http://stackoverflow.com/questions/3282655/ruby-on-rails-3-reload-lib-directory-for-each-request/4368838#4368838">StackOverflow #3282655</a> for more information.</p>

<h2>
<a name="user-content-performance-monitoring" class="anchor" href="#performance-monitoring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Performance Monitoring</h2>

<p>Grape integrates with NewRelic via the
<a href="https://github.com/flyerhzm/newrelic-grape">newrelic-grape</a> gem, and
with Librato Metrics with the <a href="https://github.com/seanmoon/grape-librato">grape-librato</a> gem.</p>

<h2>
<a name="user-content-contributing-to-grape" class="anchor" href="#contributing-to-grape" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributing to Grape</h2>

<p>Grape is work of hundreds of contributors. You're encouraged to submit pull requests, propose
features and discuss issues.</p>

<p>See <a href="CONTRIBUTING.md">CONTRIBUTING</a>.</p>

<h2>
<a name="user-content-hacking-on-grape" class="anchor" href="#hacking-on-grape" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hacking on Grape</h2>

<p>You can start hacking on Grape on
<a href="https://www.nitrous.io/?utm_source=github.com&amp;utm_campaign=grape&amp;utm_medium=hackonnitrous">Nitrous.IO</a> in a matter of seconds:</p>

<p><a href="https://www.nitrous.io/hack_button?source=embed&amp;runtime=rails&amp;repo=intridea%2Fgrape&amp;file_to_open=README.md"><img src="https://camo.githubusercontent.com/e71789c66ef2eda9da6813a4af25e04d6248b390/68747470733a2f2f64336f306d6e626776366b3932612e636c6f756466726f6e742e6e65742f6173736574732f6861636b2d6c2d76312d33636330363765373133373266363034356531393439616639643936303935622e706e67" alt="Hack intridea/grape on Nitrous.IO" data-canonical-src="https://d3o0mnbgv6k92a.cloudfront.net/assets/hack-l-v1-3cc067e71372f6045e1949af9d96095b.png" style="max-width:100%;"></a></p>

<h2>
<a name="user-content-license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>MIT License. See LICENSE for details.</p>

<h2>
<a name="user-content-copyright" class="anchor" href="#copyright" aria-hidden="true"><span class="octicon octicon-link"></span></a>Copyright</h2>

<p>Copyright (c) 2010-2013 Michael Bleigh, and Intridea, Inc.</p></article></div>