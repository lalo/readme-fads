<div class="announce instapaper_body md" data-path="README.md" id="readme"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><h1>
<a name="user-content-libcello" class="anchor" href="#libcello" aria-hidden="true"><span class="octicon octicon-link"></span></a>libCello</h1>

<p>Cello is a <em>library</em> for higher level programming in C.</p>

<ul class="task-list">
<li>
<strong>Interfaces</strong> allow for structured design</li>
<li>
<strong>Duck Typing</strong> allows for generic functions</li>
<li>
<strong>Exceptions</strong> control error handling</li>
<li>
<strong>Constructors/Destructors</strong> aid memory management</li>
<li>
<strong>Syntactic Sugar</strong> increases readability</li>
<li>
<strong>C Library</strong> means excellent performance and integration</li>
</ul><h2>
<a name="user-content-example" class="anchor" href="#example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example</h2>

<div class="highlight highlight-c"><pre><span class="cm">/* Example libCello Program */</span>

<span class="cp">#include "Cello.h"</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="cm">/* Stack objects are created using "$" */</span>
  <span class="n">var</span> <span class="n">int_item</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
  <span class="n">var</span> <span class="n">float_item</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">);</span>
  <span class="n">var</span> <span class="n">string_item</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Hello"</span><span class="p">);</span>

  <span class="cm">/* Heap objects are created using "new" */</span>
  <span class="n">var</span> <span class="n">items</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">int_item</span><span class="p">,</span> <span class="n">float_item</span><span class="p">,</span> <span class="n">string_item</span><span class="p">);</span>

  <span class="cm">/* Collections can be looped over */</span>
  <span class="n">foreach</span> <span class="p">(</span><span class="n">item</span> <span class="n">in</span> <span class="n">items</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Types are also objects */</span>
    <span class="n">var</span> <span class="n">type</span> <span class="o">=</span> <span class="n">type_of</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"Object %$ has type %$</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Heap objects destroyed with "delete" */</span>
  <span class="n">delete</span><span class="p">(</span><span class="n">items</span><span class="p">);</span> 
<span class="p">}</span>
</pre></div>

<div class="highlight highlight-c"><pre><span class="cm">/* Another Example Cello Program */</span>

<span class="cp">#include "Cello.h"</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="cm">/* Tables require "Eq" and "Hash" on key type */</span>
  <span class="n">var</span> <span class="n">prices</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Int</span><span class="p">);</span>
  <span class="n">put</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Apple"</span><span class="p">),</span>  <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">12</span><span class="p">));</span> 
  <span class="n">put</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Banana"</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span>  <span class="mi">6</span><span class="p">));</span> 
  <span class="n">put</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Pear"</span><span class="p">),</span>   <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">55</span><span class="p">));</span>

  <span class="cm">/* Tables also supports iteration */</span>
  <span class="n">foreach</span> <span class="p">(</span><span class="n">key</span> <span class="n">in</span> <span class="n">prices</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">price</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"Price of %$ is %$</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">price</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* "with" automatically closes file at end of scope. */</span>
  <span class="n">with</span> <span class="p">(</span><span class="n">file</span> <span class="n">in</span> <span class="n">stream_open</span><span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span> <span class="s">"prices.bin"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">))</span> <span class="p">{</span>

    <span class="cm">/* First class function object */</span>
    <span class="n">lambda</span><span class="p">(</span><span class="n">write_pair</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>

      <span class="cm">/* Run time type-checking with "cast" */</span>
      <span class="n">var</span> <span class="n">key</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">at</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">String</span><span class="p">);</span>
      <span class="n">var</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">Int</span><span class="p">);</span>

      <span class="n">try</span> <span class="p">{</span>
        <span class="n">print_to</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"%$ :: %$</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">e</span> <span class="n">in</span> <span class="n">IOError</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">"Could not write to file - got %$"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="n">None</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/* Higher order functions */</span>
    <span class="n">map</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">write_pair</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">delete</span><span class="p">(</span><span class="n">prices</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="user-content-inspiration" class="anchor" href="#inspiration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inspiration</h2>

<p>The high level structure of Cello projects is inspired by Haskell, while the syntax and semantics are inspired by Python and Objective-C. Cello isn't about Object Orientation in C, but I hope that with Cello I've turned C into something of a dynamic and powerful functional language which it may have once been.</p>

<p>Although the syntax is pleasant, Cello isn't a library for beginners. It is for C power users, as manual memory management doesn't play nicely with many higher-order concepts. Most of all Cello is just a fun experiment to see what C would look like when hacked to its limits.</p>

<h2>
<a name="user-content-more-examples" class="anchor" href="#more-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>More Examples</h2>

<p>Some functional tools using <code>lambda</code> statements.</p>

<div class="highlight highlight-c"><pre><span class="cp">#include "Cello.h"</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="cm">/*</span>
<span class="cm">  ** Basic method of lambda construction .</span>
<span class="cm">  ** Must be at the statement level.</span>
<span class="cm">  ** Cannot be used in/as expression.</span>
<span class="cm">  */</span>
  <span class="n">lambda</span><span class="p">(</span><span class="n">hello_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* Input is a list of arguments */</span>
    <span class="n">var</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">at</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">String</span><span class="p">);</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"Hello %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

    <span class="cm">/* Always must return */</span>
    <span class="k">return</span> <span class="n">None</span><span class="p">;</span> 
  <span class="p">};</span>

  <span class="cm">/* Functions called with "call" */</span>
  <span class="n">call</span><span class="p">(</span><span class="n">hello_name</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Bob"</span><span class="p">));</span>

  <span class="cm">/* Higher order functions supported */</span>
  <span class="n">var</span> <span class="n">names</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Dan"</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Robert"</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Chris"</span><span class="p">));</span>
  <span class="n">map</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">hello_name</span><span class="p">);</span>
  <span class="n">delete</span><span class="p">(</span><span class="n">names</span><span class="p">);</span>

  <span class="cm">/* Here is an example with two arguments */</span>
  <span class="n">lambda</span><span class="p">(</span><span class="n">add_print</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fst</span> <span class="o">=</span> <span class="n">as_long</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">at</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Int</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">snd</span> <span class="o">=</span> <span class="n">as_long</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">at</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Int</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%i + %i = %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fst</span><span class="p">,</span> <span class="n">snd</span><span class="p">,</span> <span class="n">fst</span><span class="o">+</span><span class="n">snd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">None</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/*</span>
<span class="cm">  ** Notice arguments to "call" in curried form.</span>
<span class="cm">  ** Use "call_with" for uncurried calling.</span>
<span class="cm">  */</span>
  <span class="n">call</span><span class="p">(</span><span class="n">add_print</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">21</span><span class="p">));</span>

  <span class="cm">/* Partially applied Function, neat! */</span>
  <span class="n">lambda_partial</span><span class="p">(</span><span class="n">add_partial</span><span class="p">,</span> <span class="n">add_print</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

  <span class="n">call</span><span class="p">(</span><span class="n">add_partial</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

  <span class="cm">/*</span>
<span class="cm">  ** We can use normal c-functions too.</span>
<span class="cm">  ** If they have all argument types as "var".</span>
<span class="cm">  ** Then they can be uncurried.</span>
<span class="cm">  */</span>
  <span class="n">var</span> <span class="n">Welcome_Pair</span><span class="p">(</span><span class="n">var</span> <span class="n">fst</span><span class="p">,</span> <span class="n">var</span> <span class="n">snd</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"Hello %s and %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fst</span><span class="p">,</span> <span class="n">snd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">None</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">lambda_uncurry</span><span class="p">(</span><span class="n">welcome_uncurried</span><span class="p">,</span> <span class="n">Welcome_Pair</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

  <span class="n">call</span><span class="p">(</span><span class="n">welcome_uncurried</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"John"</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"David"</span><span class="p">));</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="user-content-more-more-examples" class="anchor" href="#more-more-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>More More Examples</h2>

<p><strong>Defining a new Class.</strong></p>

<p>A Class is a TypeClass, also known as an Interface. These are defined to allow overloaded or generic functions.</p>

<p>They are defined as follows.</p>

<p>In the header...</p>

<div class="highlight highlight-c"><pre><span class="cm">/** Vector - vector operations */</span>

<span class="n">class</span> <span class="p">{</span>
  <span class="kt">float</span> <span class="p">(</span><span class="o">*</span><span class="n">dot</span><span class="p">)(</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
  <span class="kt">float</span> <span class="p">(</span><span class="o">*</span><span class="n">length</span><span class="p">)(</span><span class="n">var</span><span class="p">);</span>
<span class="p">}</span> <span class="n">Vector</span><span class="p">;</span>

<span class="kt">float</span> <span class="nf">dot</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">);</span>
<span class="kt">float</span> <span class="nf">length</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">);</span>
</pre></div>

<p>And in the source file...</p>

<div class="highlight highlight-c"><pre><span class="kt">float</span> <span class="nf">dot</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">type_class_method</span><span class="p">(</span><span class="n">type_of</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">length</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">type_class_method</span><span class="p">(</span><span class="n">type_of</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p><strong>Defining a new Type.</strong></p>

<p>A Type is an structure which implements a number of Classes.</p>

<p>They typically have an associated data object. They can be defined as follows.</p>

<p>In the header...</p>

<div class="highlight highlight-c"><pre><span class="n">global</span> <span class="n">var</span> <span class="n">Vec2</span><span class="p">;</span>

<span class="n">data</span> <span class="p">{</span>
  <span class="n">var</span> <span class="n">type</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Vec2Data</span><span class="p">;</span>

<span class="n">var</span> <span class="nf">Vec2_New</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var_list</span> <span class="n">vl</span><span class="p">);</span>
<span class="n">var</span> <span class="nf">Vec2_Delete</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">);</span>
<span class="kt">size_t</span> <span class="nf">Vec2_Size</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Vec2_Assign</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">);</span>
<span class="n">var</span> <span class="nf">Vec2_Copy</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">);</span>

<span class="n">var</span> <span class="nf">Vec2_Eq</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">);</span>

<span class="kt">float</span> <span class="nf">Vec2_Dot</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">);</span>
<span class="kt">float</span> <span class="nf">Vec2_Length</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">);</span>

<span class="n">instance</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">New</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Vec2_New</span><span class="p">,</span> <span class="n">Vec2_Delete</span><span class="p">,</span> <span class="n">Vec2_Size</span> <span class="p">};</span>
<span class="n">instance</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Assign</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Vec2_Assign</span> <span class="p">};</span>
<span class="n">instance</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Copy</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Vec2_Copy</span> <span class="p">};</span>
<span class="n">instance</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Eq</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Vec2_Eq</span> <span class="p">};</span>
<span class="n">instance</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Vec2_Dot</span><span class="p">,</span> <span class="n">Vec2_Length</span> <span class="p">};</span>
</pre></div>

<p>And in the source file...</p>

<div class="highlight highlight-c"><pre><span class="n">var</span> <span class="n">Vec2</span> <span class="o">=</span> <span class="n">type_data</span> <span class="p">{</span>
  <span class="n">type_begin</span><span class="p">(</span><span class="n">Vec2</span><span class="p">),</span>
  <span class="n">type_entry</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">New</span><span class="p">),</span>
  <span class="n">type_entry</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Assign</span><span class="p">),</span>
  <span class="n">type_entry</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Copy</span><span class="p">),</span>
  <span class="n">type_entry</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Eq</span><span class="p">),</span>
  <span class="n">type_entry</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="n">Vector</span><span class="p">),</span>
  <span class="n">type_end</span><span class="p">(</span><span class="n">Vec2</span><span class="p">)</span>
<span class="p">};</span>

<span class="n">var</span> <span class="nf">Vec2_New</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var_list</span> <span class="n">vl</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="n">v</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">as_double</span><span class="p">(</span><span class="n">var_list_get</span><span class="p">(</span><span class="n">vl</span><span class="p">));</span>
  <span class="n">v</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">as_double</span><span class="p">(</span><span class="n">var_list_get</span><span class="p">(</span><span class="n">vl</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">var</span> <span class="nf">Vec2_Delete</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">Vec2_Size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Vec2Data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Vec2_Assign</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="n">v1</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
  <span class="n">v1</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">var</span> <span class="nf">Vec2_Copy</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">new</span><span class="p">(</span><span class="n">Vec2</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">var</span> <span class="nf">Vec2_Eq</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">bool_var</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">x</span> <span class="n">is</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">x</span> <span class="n">and</span> <span class="n">v1</span><span class="o">-&gt;</span><span class="n">y</span> <span class="n">is</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">Vec2_Dot</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">,</span> <span class="n">var</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">*</span> <span class="n">v2</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">Vec2_Length</span><span class="p">(</span><span class="n">var</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec2Data</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="user-content-more-more-more-examples" class="anchor" href="#more-more-more-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>More More More Examples</h2>

<p>Memory management is hard. Very hard when combined with a lack of rich stack types. Very very hard when combined with a whole load of high level concepts. libCello gives you a few options, which where possible, the standard library is agnostic too. You can use what you think is best.</p>

<ul class="task-list">
<li>
<strong>Destructive Operations</strong> - Most of the standard library uses destructive operations and expects the user to make a copy if they explicitly want one.</li>
<li>
<strong>Output Parameters</strong> - In some places it is more appropriate to use output parameters and in which case <code>assign</code> is used to move the data around. </li>
<li>
<strong>Reference Objects</strong> - References wrap standard objects, where <code>with</code> can be used to declare their lifetime. And <code>at</code> can be used to dereference.</li>
</ul><div class="highlight highlight-c"><pre><span class="n">local</span> <span class="kt">void</span> <span class="nf">object_lifetime_example</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">var</span> <span class="n">life</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Life is long"</span><span class="p">)</span>

  <span class="n">with</span><span class="p">(</span><span class="n">liferef</span> <span class="n">in</span> <span class="err">$</span><span class="p">(</span><span class="n">Reference</span><span class="p">,</span> <span class="n">new</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">life</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"This string is alive: %$</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">at</span><span class="p">(</span><span class="n">liferef</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">print</span><span class="p">(</span><span class="s">"Now it has been cleared up!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* They can also be stacked */</span>

<span class="n">local</span> <span class="kt">void</span> <span class="nf">many_object_lifetimes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">var</span> <span class="n">life0</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Life is long"</span><span class="p">)</span>
  <span class="n">var</span> <span class="n">life1</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Life is Beautiful"</span><span class="p">)</span>
  <span class="n">var</span> <span class="n">life2</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Life is Grand"</span><span class="p">)</span>

  <span class="n">with</span><span class="p">(</span><span class="n">liferef0</span> <span class="n">in</span> <span class="err">$</span><span class="p">(</span><span class="n">Reference</span><span class="p">,</span> <span class="n">new</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">life0</span><span class="p">)))</span>
  <span class="n">with</span><span class="p">(</span><span class="n">liferef1</span> <span class="n">in</span> <span class="err">$</span><span class="p">(</span><span class="n">Reference</span><span class="p">,</span> <span class="n">new</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">life1</span><span class="p">)))</span>
  <span class="n">with</span><span class="p">(</span><span class="n">liferef2</span> <span class="n">in</span> <span class="err">$</span><span class="p">(</span><span class="n">Reference</span><span class="p">,</span> <span class="n">new</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">life2</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"%s :: %s :: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">at</span><span class="p">(</span><span class="n">liferef0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">at</span><span class="p">(</span><span class="n">liferef1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">at</span><span class="p">(</span><span class="n">liferef2</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<ul class="task-list">
<li>
<strong>Reference Pools</strong> - Reference pools are also avaliable which use <code>retain</code> and <code>release</code> to providing a reference counting mechanism.</li>
</ul><div class="highlight highlight-c"><pre><span class="cp">#include "Cello.h"</span>

<span class="n">local</span> <span class="n">var</span> <span class="n">g_pool</span><span class="p">;</span>

<span class="n">local</span> <span class="kt">void</span> <span class="nf">table_fill</span><span class="p">(</span><span class="n">var</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"First"</span><span class="p">),</span>  <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">));</span>
  <span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Second"</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">));</span>
  <span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"Third"</span><span class="p">),</span>  <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="mf">5.7</span><span class="p">));</span>
  <span class="n">release</span><span class="p">(</span><span class="n">g_pool</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">local</span> <span class="kt">void</span> <span class="nf">table_process</span><span class="p">(</span><span class="n">var</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">"First"</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.65</span><span class="p">));</span>
  <span class="n">release</span><span class="p">(</span><span class="n">g_pool</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">g_pool</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Pool</span><span class="p">);</span>

  <span class="n">var</span> <span class="n">x</span> <span class="o">=</span> <span class="n">retain</span><span class="p">(</span><span class="n">g_pool</span><span class="p">,</span> <span class="n">new</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Real</span><span class="p">));</span>

  <span class="n">table_fill</span><span class="p">(</span><span class="n">retain</span><span class="p">(</span><span class="n">g_pool</span><span class="p">,</span> <span class="n">x</span><span class="p">));</span>
  <span class="n">table_process</span><span class="p">(</span><span class="n">retain</span><span class="p">(</span><span class="n">g_pool</span><span class="p">,</span> <span class="n">x</span><span class="p">));</span>

  <span class="n">release</span><span class="p">(</span><span class="n">g_pool</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

  <span class="n">delete</span><span class="p">(</span><span class="n">g_pool</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>

<p>While useless in such a trivial example, because the pool always cleans up references on delete, it can be very useful to avoid memory leaks in things such as event loops or with general pooled memory. It can be used as a poor man's sweep garbage collector.</p>

<h2>
<a name="user-content-more-more-more-more-examples" class="anchor" href="#more-more-more-more-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>More More More More Examples</h2>

<p>libCello provides a kind of exception handling to deal with errors.</p>

<div class="highlight highlight-c"><pre><span class="n">local</span> <span class="n">var</span> <span class="n">DivideByZeroError</span> <span class="o">=</span> <span class="n">Singleton</span><span class="p">(</span><span class="n">DivideByZeroError</span><span class="p">);</span>

<span class="n">local</span> <span class="kt">int</span> <span class="nf">try_divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">throw</span><span class="p">(</span><span class="n">DivideByZeroError</span><span class="p">,</span> <span class="s">"Division By Zero (%i / %i)"</span><span class="p">,</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="err">$</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">try</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">try_divide</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">e</span> <span class="n">in</span> <span class="n">DivideByZeroError</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Panic!</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>One can also catch multiple objects and then write conditional code based on each. Or one can catch all exceptions or any thrown object by leaving the specifier list empty.</p>

<div class="highlight highlight-c"><pre><span class="n">try</span> <span class="p">{</span>
  <span class="n">do_some_work</span><span class="p">();</span>
<span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">e</span> <span class="n">in</span> <span class="n">TypeError</span><span class="p">,</span> <span class="n">ClassError</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="n">is</span> <span class="n">TypeError</span><span class="p">)</span> <span class="p">{</span> <span class="n">print</span><span class="p">(</span><span class="s">"Got TypeError!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="n">is</span> <span class="n">ClassError</span><span class="p">)</span> <span class="p">{</span> <span class="n">print</span><span class="p">(</span><span class="s">"Got ClassError!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">try</span> <span class="p">{</span>
  <span class="n">do_some_other_word</span><span class="p">();</span>
<span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">print</span><span class="p">(</span><span class="s">"Got Exception: %$</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Throwing an exception will jump the program control to the innermost <code>catch</code> block. If it is not handled here it is passed on to an outer block. To catch an exception one must put a reference to the thrown object. Any object can be thrown and caught as an Exception in libCello so users can create their own Exception types or find other applications for the semantics. The thrown message will be preserved internally, but be careful of throwing stack memory which may become invalidated when jumping to the new location. The <code>catch</code> part of a exception block must always be evaluated at risk of breaking the exception stack. This means it must always be included and one should never return from inside a <code>try</code> block. To retrieve the exception message thrown one can use <code>Exception_Message</code>.</p>

<h2>
<a name="user-content-more-more-more-more-more-examples" class="anchor" href="#more-more-more-more-more-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>More More More More More Examples</h2>

<p>There are some more examples in the demos folder as well as a large amount of reference material under tests, documentation and source code. Native class definitions (such as for <code>New</code>, <code>Eq</code>, <code>Ord</code>) can be found in <code>Prelude.h</code></p>

<h2>
<a name="user-content-explanation" class="anchor" href="#explanation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Explanation</h2>

<p>The first thing that probably comes into your head viewing the above code is <code>var</code>. This is a typedef of <code>void*</code> and is used via convention in libCello code to allow for overloaded functions. As you can see in the example code type checking/hinting can be done at runtime via the <code>cast</code> function.</p>

<p>This allows for a form of poor-man's duck-typing. If an object looks (or sounds) like it has a length, then you are more than free to use <code>len</code> upon it. One can test if a type implements a certain class with the function <code>type_implements(type, Class)</code>. Calling a function on an object which does not implement the appropriate classes will throw a <code>ClassError</code>.</p>

<p>Another thing that may have jumped to your mind in the examples is <code>new</code>, <code>delete</code> and the <code>$</code> symbol. These are ways to allocate memory for objects. <code>new</code> and <code>delete</code> are used for heap objects and call constructors/destructors. <code>$</code> (which I like to think of as a clef) is used to allocate objects on the stack. It <strong>doesn't</strong> call a constructor or destructor, but will initialize the corresponding types data structure with the arguments provided. This makes it useful for basic or boxed types.</p>

<p>The idea of <code>with</code> is stolen from Python and will execute <code>enter_with</code> and <code>exit_with</code> on an object on entrance and exit to the block. The behaviour of these can be defined by implementing the <code>With</code> class. Currently it does not handle exceptions inside the block.</p>

<p>Other than these things there is not much surprising in the code which cannot be explained via syntactic sugar.</p>

<ul class="task-list">
<li>
<code>is</code>, <code>isnt</code>, <code>not</code>, <code>and</code>, <code>or</code> -&gt; <code>==</code>, <code>!=</code>, <code>!</code>, <code>&amp;&amp;</code>, <code>||</code>
</li>
<li>
<code>elif</code> -&gt; <code>else if</code>
</li>
<li>
<code>local</code> -&gt; <code>static</code>
</li>
<li>
<code>global</code> -&gt; <code>extern</code>
</li>
<li>
<code>class</code> -&gt; <code>typedef struct</code>
</li>
<li>
<code>data</code> -&gt; <code>typedef struct</code>
</li>
</ul><p>finally the <code>instance</code> and <code>methods</code> macros are helpers for defining Type objects statically. Because Type objects are somewhat complicated the syntax is very awkward otherwise.</p>

<h2>
<a name="user-content-questions--contributions" class="anchor" href="#questions--contributions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Questions &amp; Contributions</h2>

<p>Questions, Contributions and Feedback are more than welcome.</p>

<p>You can e-mail me at:</p>

<p><code>contact@theorangeduck.com</code></p>

<p>Or get in contact via the IRC channel at <code>#libCello</code> on Freenode</p></article></div>