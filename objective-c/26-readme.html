<div class="announce instapaper_body md" data-path="README.md" id="readme"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><h1>
<a name="user-content-newsblur" class="anchor" href="#newsblur" aria-hidden="true"><span class="octicon octicon-link"></span></a>NewsBlur</h1>

<ul class="task-list">
<li>NewsBlur is a personal news reader bringing people together 
to talk about the world. A new sound of an old instrument.</li>
<li>
<a href="http://www.newsblur.com">www.newsblur.com</a>.</li>
<li>Created by <a href="http://www.samuelclay.com">Samuel Clay</a>. </li>
<li>Twitter: <a href="http://twitter.com/samuelclay">@samuelclay</a> and 
<a href="http://twitter.com/newsblur">@newsblur</a>.</li>
</ul><h2>
<a name="user-content-features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h2>

<ol class="task-list">
<li>Shows the original site (you have to see it to believe it).</li>
<li>Hides stories you don't want to read based on tags, keywords, authors, etc.</li>
<li>Highlights stories you want to read, based on the same criteria.</li>
</ol><h2>
<a name="user-content-technologies" class="anchor" href="#technologies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Technologies</h2>

<h3>
<a name="user-content-server-side" class="anchor" href="#server-side" aria-hidden="true"><span class="octicon octicon-link"></span></a>Server-side</h3>

<ul class="task-list">
<li>
<a href="http://www.djangoproject.com">Django</a>: Web framework written in Python, used 
to serve all pages.</li>
<li>
<a href="http://ask.github.com/celery">Celery</a> &amp; <a href="http://www.rabbitmq.com">RabbitMQ</a>: 
Asynchronous queueing server, used to fetch and parse RSS feeds.</li>
<li>
<a href="http://www.mongodb.com">MongoDB</a>, <a href="http://www.mongodb.com/pymongo">Pymongo</a>, &amp; 
<a href="http://www.github.com/hmarr/mongoengine">Mongoengine</a>: Non-relational database, 
used to store stories, read stories, feed/page fetch histories, and proxied sites.</li>
<li>
<a href="http://www.postgresql.com">PostgreSQL</a>: Relational database, used to store feeds, 
subscriptions, and user accounts.</li>
</ul><h3>
<a name="user-content-client-side-and-design" class="anchor" href="#client-side-and-design" aria-hidden="true"><span class="octicon octicon-link"></span></a>Client-side and design</h3>

<ul class="task-list">
<li>
<a href="http://www.jquery.com">jQuery</a>: Cross-browser compliant JavaScript code. IE works without effort.</li>
<li>
<a href="http://documentcloud.github.com/underscore/">Underscore.js</a>: Functional programming for JavaScript. 
Indispensible.</li>
<li>Miscellaneous jQuery Plugins: Everything from resizable layouts, to progress 
bars, sortables, date handling, colors, corners, JSON, animations. 
<a href="https://github.com/samuelclay/NewsBlur/tree/master/media/js">See the complete list</a>.</li>
</ul><h2>
<a name="user-content-installation-instructions" class="anchor" href="#installation-instructions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation Instructions</h2>

<h3>
<a name="user-content-prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h3>

<h4>
<a name="user-content-relational-database-mysql-postgresql" class="anchor" href="#relational-database-mysql-postgresql" aria-hidden="true"><span class="octicon octicon-link"></span></a>Relational Database (MySQL, PostgreSQL)</h4>

<p>You will want to have your database set up before you begin installation. Fabric can install
both PostgreSQL and MongoDB for you, but only on Ubuntu. Mac OS X users will want to have
MySQL or PostgreSQL already installed. You can <a href="http://dev.mysql.com/downloads/mysql/">download MySQL</a>
or <a href="http://www.postgresql.org/download/">download PostgreSQL</a>. Additionally,
if running as a development machine on Mac OS X, I would recommend using MySQL with 
<a href="http://www.sequelpro.com/">Sequel Pro</a> as a GUI.</p>

<p>If you are installing MySQL, you will also need the MySQLDB python library:</p>

<pre><code>sudo easy_install mysql-python
</code></pre>

<h4>
<a name="user-content-fabric" class="anchor" href="#fabric" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fabric</h4>

<p>Both Mac OS X and Linux require <a href="http://docs.fabfile.org/">Fabric</a> to be installed. 
Many common tasks, such as installing dependencies, deploying servers, migrations,
and configurations are in <code>fabfile.py</code>.</p>

<pre><code>sudo easy_install fabric
</code></pre>

<p>On recent installations of Mac OS X using XCode 4, you may run into issues around the 
<code>ppc</code> architecture. To fix this, simply run:</p>

<pre><code>sudo ln -s /Developer/Platforms/iPhoneOS.platform/Developer/usr/libexec/gcc/darwin/ppc \
/Developer/usr/libexec/gcc/darwin
sudo ln -s /Developer/Platforms/iPhoneOS.platform/Developer/usr/libexec/gcc/darwin/ppc \
/usr/libexec/gcc/darwin
</code></pre>

<p>Sym-linking the ppc architecture comes from this StackOverflow answer on 
"<a href="http://stackoverflow.com/questions/5256397/">assembler for architecture ppc not installed on Mac OS</a>".</p>

<h4>
<a name="user-content-mongodb" class="anchor" href="#mongodb" aria-hidden="true"><span class="octicon octicon-link"></span></a>MongoDB</h4>

<p>On top of MySQL/PostgreSQL, NewsBlur uses MongoDB to store non-relational data. You will want to 
<a href="http://www.mongodb.org/downloads">download MongoDB</a>. If you are on Ubuntu, the <code>setup_mongo</code> Fabric 
command will automatically do this for you, but Mac OS X needs to have it installed manually.</p>

<h4>
<a name="user-content-numpy-and-scipy" class="anchor" href="#numpy-and-scipy" aria-hidden="true"><span class="octicon octicon-link"></span></a>Numpy and Scipy</h4>

<p>Not the easiest to get installed. If you are running Mac OS X, you have a few options:</p>

<ul class="task-list">
<li>Use the <a href="http://fonnesbeck.github.com/ScipySuperpack/">Superpack by Chris Fonnesbeck</a>
</li>
<li>Use MacPorts: <code>sudo port install py26-numpy py26-scipy</code>
</li>
<li>Install from source (grueling): <a href="http://www.scipy.org/Download">http://www.scipy.org/Download</a>
</li>
<li>Use a combination of pip, easy_install, and <a href="http://mxcl.github.com/homebrew/">homebrew</a>: <code>pip install numpy &amp;&amp; brew install gfortran &amp;&amp; easy_install scipy</code>
</li>
</ul><h4>
<a name="user-content-other-assorted-packages" class="anchor" href="#other-assorted-packages" aria-hidden="true"><span class="octicon octicon-link"></span></a>Other assorted packages</h4>

<p>From inside the repository, run: </p>

<pre><code>pip install -r requirements.txt
</code></pre>

<h3>
<a name="user-content-configure-paths" class="anchor" href="#configure-paths" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure paths</h3>

<p>In <code>fabfile.py</code> there are two paths that need to be configured. </p>

<ul class="task-list">
<li>
<code>env.paths.NEWSBLUR</code> is the relative path to the NewsBlur repository.</li>
<li>
<code>env.paths.VENDOR</code> is the relative path to where all downloaded code should go.</li>
</ul><p>In <code>local_settings.py</code> there are a few paths that need to be configured. Configure 
these after the installation below.</p>

<h3>
<a name="user-content-installing-on-mac-os-x" class="anchor" href="#installing-on-mac-os-x" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing on Mac OS X</h3>

<ol class="task-list">
<li>
<p>Using Mac OS X as a development environment, you can run all three servers (app, db, task) 
on the same system. You should have <a href="http://docs.fabfile.org/">Fabric</a> installed to run 
the <code>fabfile.py</code>. You should also have MySQL/PostgreSQL and MongoDB already installed.</p>

<pre><code>fab -R local setup_python
fab -R local setup_imaging
fab -R local setup_mongoengine
fab -R local setup_forked_mongoengine
fab -R local setup_repo_local_settings
fab -R local compress_assets
</code></pre>

<p>If any of the packages fail to install (<code>lxml</code>, for instance), look through <code>fabfile.py</code> 
and check if there is a function that can be used to circumvent broken easy_install 
processes. For example, lxml may need libxslt and libxml2 to be installed. This is 
automated with the following Fabric command:</p>

<pre><code>fab -R local setup_libxml_code
</code></pre>
</li>
<li>
<p>Configure MySQL/PostgreSQL by adding in a <code>newsblur</code> user and a <code>newsblur</code> database. Here's an example for MySQL:</p>

<pre><code>mysql_install_db --verbose --user=`whoami` --basedir="$(brew --prefix mysql)" --datadir=/path/to/var/mysql --tmpdir=/tmp
mysql.server start
mysql -u root
&gt; CREATE USER 'newsblur'@'localhost' IDENTIFIED BY '';
&gt; GRANT ALL PRIVILEGES ON *.* TO 'newsblur'@'localhost' WITH GRANT OPTION;
&gt; CREATE DATABASE newsblur;
&gt; exit
</code></pre>

<p>Then load up the database with empty NewsBlur tables and bootstrap the database:</p>

<pre><code>./manage.py syncdb --all
./manage.py migrate --fake
./manage.py migrate
./manage.py loaddata config/fixtures/bootstrap.json
</code></pre>

<p>If you don't create a user during <code>syncdb</code>, the <code>bootstrap.json</code> file will create a 
newsblur user with no password.</p>
</li>
<li>
<p>Start mongodb (if not already running):</p>

<pre><code>mongod run
</code></pre>
</li>
<li>
<p>Run the development server. At this point, all dependencies should be installed and no
additional configuration is needed. If you find that something is not working at this
point, please email the resulting output to Samuel Clay at 
<a href="samuel@newsblur.com">samuel@newsblur.com</a>.</p>

<pre><code>./manage.py runserver
</code></pre>
</li>
<li>
<p>Navigate to: </p>

<pre><code> http://localhost:8000/ 
</code></pre>

<p>Create an account. At the end of the account creation process, you
will be redirected to https://localhost/profile/stripe_form. Hit
the back button a few times, and you will be inside the app.</p>
</li>
</ol><h3>
<a name="user-content-installing-on-linux--ubuntu" class="anchor" href="#installing-on-linux--ubuntu" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing on Linux / Ubuntu</h3>

<p>If you are on Ubuntu, you can simply use <a href="http://docs.fabfile.org/">Fabric</a> to install 
NewsBlur and its many components. NewsBlur is designed to run on three separate servers: 
an app server, a db server, and assorted task servers. To install everything on a single 
machine, read through <code>fabfile.py</code> and setup all three servers without repeating the 
<code>setup_common</code> steps.</p>

<h3>
<a name="user-content-finishing-installation" class="anchor" href="#finishing-installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finishing Installation</h3>

<p>You must perform a few tasks to tie all of the various systems together.</p>

<ol class="task-list">
<li>
<p>First, copy local_settings.py and fill in your OAuth keys, S3 keys, database names (if not <code>newsblur</code>),
task server/broker address (RabbitMQ), and paths:</p>

<pre><code>cp local_settings.py.template local_settings.py
</code></pre>

<p>Edit local_settings.py to change any keys that you have.</p>
</li>
<li>
<p>Create the <code>newsblur</code> database in MySQL/PostgreSQL</p>

<h4>
<a name="user-content-mysqlpostgresql" class="anchor" href="#mysqlpostgresql" aria-hidden="true"><span class="octicon octicon-link"></span></a>MySQL/PostgreSQL</h4>

<pre><code>./manage.py syncdb
</code></pre>
</li>
</ol><h4>
<a name="user-content-app-server" class="anchor" href="#app-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>App server</h4>

<pre><code>fab -R local setup_app
</code></pre>

<h4>
<a name="user-content-database-server" class="anchor" href="#database-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database server</h4>

<pre><code>fab -R local setup_db
</code></pre>

<h4>
<a name="user-content-task-server" class="anchor" href="#task-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task server</h4>

<pre><code>fab -R local setup_task
</code></pre>

<h2>
<a name="user-content-keeping-newsblur-running" class="anchor" href="#keeping-newsblur-running" aria-hidden="true"><span class="octicon octicon-link"></span></a>Keeping NewsBlur Running</h2>

<p>These commands keep NewsBlur fresh and updated. While on a development server, these 
commands do not need to be run more than once. However, you will probably want to run
the <code>refresh_feeds</code> command regularly so you have new stories to test with and read.</p>

<h3>
<a name="user-content-fetching-feeds" class="anchor" href="#fetching-feeds" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fetching feeds</h3>

<p>If you just want to fetch feeds once, you can use the <code>refresh_feeds</code> management command:</p>

<pre><code>./manage.py refresh_feeds --force
</code></pre>

<p>You can also fetch the feeds for a specific user:</p>

<pre><code>./manage.py refresh_feeds --user=newsblur --force
</code></pre>

<h3>
<a name="user-content-feedback" class="anchor" href="#feedback" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feedback</h3>

<p>To populate the feedback table on the homepage, use the <code>collect_feedback</code> management 
command every few minutes:</p>

<pre><code>./manage.py collect_feedback
</code></pre>

<h3>
<a name="user-content-statistics" class="anchor" href="#statistics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Statistics</h3>

<p>To populate the statistics graphs on the homepage, use the <code>collect_stats</code> management 
command every few minutes:</p>

<pre><code>./manage.py collect_stats
</code></pre>

<h3>
<a name="user-content-running-unit-and-integration-tests" class="anchor" href="#running-unit-and-integration-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running unit and integration tests</h3>

<p>NewsBlur comes complete with a test suite that tests the functionality of the rss_feeds,
reader, and feed importer. To run the test suite:</p>

<pre><code>./manage.py test --settings=utils.test-settings
</code></pre>

<h2>
<a name="user-content-in-case-of-downtime" class="anchor" href="#in-case-of-downtime" aria-hidden="true"><span class="octicon octicon-link"></span></a>In Case of Downtime</h2>

<p>You got the downtime message either through email or SMS. This is the order of operations for determining what's wrong.</p>

<ol class="task-list">
<li><p>Ensure you have <code>secrets-newsblur/configs/hosts</code> installed in your <code>/etc/hosts</code> so server hostnames 
work.</p></li>
<li>
<p>Check <a href="http://www.newsblur.com">www.newsblur.com</a> to confirm it's down.</p>

<p>If you don't get a 502 page, then NewsBlur isn't even reachable and you just need to contact the
hosting provider and yell at them.</p>
</li>
<li>
<p>Check <a href="https://app.getsentry.com/newsblur/app/">Sentry</a> and see if the answer is at the top of the 
list.</p>

<p>This will show if a database (redis, mongo, postgres) can't be found.</p>
</li>
<li>
<p>Check the various databases:</p>

<p>a. If Redis server (db_redis, db_redis_story, db_redis_pubsub) can't connect, redis is probably down.</p>

<pre><code>SSH into the offending server (or just check both the `db_redis` and `db_redis_story` servers) and
check if `redis` is running. You can often `tail -f -n 100 /var/log/redis.log` to find out if
background saving was being SIG(TERM|INT)'ed. When redis goes down, it's always because it's
consuming too much memory. That shouldn't happen, so check the [munin
graphs](http://db_redis/munin/).

Boot it with `sudo /etc/init.d/redis start`.
</code></pre>

<p>b. If mongo (db_mongo) can't connect, mongo is probably down.</p>

<pre><code>This is rare and usually signifies hardware failure. SSH into `db_mongo` and check logs with `tail
-f -n 100 /var/log/mongodb/mongodb.log`. Start mongo with `sudo /etc/init.d/mongodb start` then
promote the next largest mongodb server. You want to then promote one of the secondaries to
primary, kill the offending primary machine, and rebuild it (preferably at a higher size). I
recommend waiting a day to rebuild it so that you get a different machine. Don't forget to lodge a
support ticket with the hosting provider so they know to check the machine.

If it's the db_mongo_analytics machine, there is no backup nor secondaries of the data (because
it's ephemeral and used for, you guessed it, analytics). You can easily provision a new mongodb
server and point to that machine.
</code></pre>

<p>c. If postgresql (db_pgsql) can't connect, postgres is probably down.</p>

<pre><code>This is the rarest of the rare and has in fact never happened. Machine failure. If you can salvage
the db data, move it to another machine. Worst case you have nightly backups in S3. The fabfile.py
has commands to assist in restoring from backup (the backup file just needs to be local).
</code></pre>
</li>
<li>
<p>Point to a new/different machine</p>

<p>a. Confirm the IP address of the new machine with <code>fab list_do</code>.</p>

<p>b. Change <code>secrets-newsbur/config/hosts</code> to reflect the new machine.</p>

<p>c. Copy the new <code>hosts</code> file to all machines with:</p>

<pre><code>   fab all setup_hosts
   fab ec2task setup_hosts
</code></pre>

<p>d. Changes should be instant, but you can also bounce every machine with:</p>

<pre><code>   fab web deploy:fast=True # fast=True just kill -9's processes.
   fab task celery
   fab ec2task celery
</code></pre>

<p>e. Monitor tlnb.py and tlnbt.py for lots of reading and feed fetching.    </p>

<ol class="task-list">
<li>
<p>If feeds aren't fetching, check that the <code>tasked_feeds</code> queue is empty. You can drain it by running:</p>

<pre><code>Feed.drain_task_feeds()
</code></pre>

<p>This happens when a deploy on the task servers hits faults and the task servers lose their connection without giving the tasked feeds back to the queue. Feeds that fall through this crack are automatically fixed after 24 hours, but if many feeds fall through due to a bad deploy, you'll want to accelerate that check by just draining the tasked feeds pool, adding those feeds back into the queue.</p>
</li>
</ol>
</li>
</ol><h2>
<a name="user-content-author" class="anchor" href="#author" aria-hidden="true"><span class="octicon octicon-link"></span></a>Author</h2>

<ul class="task-list">
<li>Created by <a href="http://www.samuelclay.com">Samuel Clay</a>.</li>
<li>Email address: <a href="mailto:samuel@newsblur.com">samuel@newsblur.com</a>
</li>
<li>
<a href="http://twitter.com/samuelclay">@samuelclay</a> on Twitter.</li>
</ul><h2>
<a name="user-content-license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>NewsBlur is licensed under the MIT License. (See LICENSE)</p></article></div>