<div class="announce instapaper_body md" data-path="README.md" id="readme"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><h1>
<a name="user-content-table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of Contents</h1>

<ul class="task-list">
<li>
<a href="#introduction">Introduction</a>

<ul class="task-list">
<li><a href="#version">Version</a></li>
<li><a href="Changelog.md">Changelog</a></li>
</ul>
</li>
<li>
<a href="#hardware-requirements">Hardware Requirements</a>

<ul class="task-list">
<li><a href="#cpu">CPU</a></li>
<li><a href="#memory">Memory</a></li>
<li><a href="#storage">Storage</a></li>
</ul>
</li>
<li><a href="#supported-web-browsers">Supported Web Browsers</a></li>
<li><a href="#reporting-issues">Reporting Issues</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#quick-start">Quick Start</a></li>
<li>
<a href="#configuration">Configuration</a>

<ul class="task-list">
<li><a href="#data-store">Data Store</a></li>
<li>
<a href="#database">Database</a>

<ul class="task-list">
<li>
<a href="#mysql">MySQL</a>

<ul class="task-list">
<li><a href="#internal-mysql-server">Internal MySQL Server</a></li>
<li><a href="#external-mysql-server">External MySQL Server</a></li>
<li><a href="#linking-to-mysql-container">Linking to MySQL Container</a></li>
</ul>
</li>
<li>
<a href="#postgresql">PostgreSQL (Recommended)</a>

<ul class="task-list">
<li><a href="#external-postgresql-server">External PostgreSQL Server</a></li>
<li><a href="#linking-to-postgresql-container">Linking to PostgreSQL Container</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#redis">Redis</a>

<ul class="task-list">
<li><a href="#internal-redis-server">Internal Redis Server</a></li>
<li><a href="#external-redis-server">External Redis Server</a></li>
<li><a href="#linking-to-redis-container">Linking to Redis Container</a></li>
</ul>
</li>
<li><a href="#mail">Mail</a></li>
<li>
<a href="#ssl">SSL</a>

<ul class="task-list">
<li><a href="#generation-of-self-signed-certificates">Generation of Self Signed Certificates</a></li>
<li><a href="#strengthening-the-server-security">Strengthening the server security</a></li>
<li><a href="#installation-of-the-certificates">Installation of the Certificates</a></li>
<li><a href="#enabling-https-support">Enabling HTTPS support</a></li>
<li><a href="#using-https-with-a-load-balancer">Using HTTPS with a load balancer</a></li>
<li><a href="#establishing-trust-with-your-server">Establishing trust with your server</a></li>
<li><a href="#installing-trusted-ssl-server-certificates">Installing Trusted SSL Server Certificates</a></li>
</ul>
</li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
<li><a href="#run-under-sub-uri">Run under sub URI</a></li>
<li>
<a href="#omniauth-integration">OmniAuth Integration</a>

<ul class="task-list">
<li><a href="#google">Google</a></li>
<li><a href="#twitter">Twitter</a></li>
<li><a href="#github">GitHub</a></li>
</ul>
</li>
<li>
<a href="#external-issue-trackers">External Issue Trackers</a>

<ul class="task-list">
<li><a href="#redmine">Redmine</a></li>
<li><a href="#jira">Jira</a></li>
</ul>
</li>
<li><a href="#available-configuration-parameters">Available Configuration Parameters</a></li>
</ul>
</li>
<li>
<a href="#maintenance">Maintenance</a>

<ul class="task-list">
<li><a href="#creating-backups">Creating Backups</a></li>
<li><a href="#restoring-backups">Restoring Backups</a></li>
<li><a href="#automated-backups">Automated Backups</a></li>
<li><a href="#shell-access">Shell Access</a></li>
</ul>
</li>
<li><a href="#upgrading">Upgrading</a></li>
<li><a href="#rake-tasks">Rake Tasks</a></li>
<li><a href="https://github.com/sameersbn/docker-gitlab/issues/39">Announcements</a></li>
<li><a href="#references">References</a></li>
</ul><h1>
<a name="user-content-introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>Dockerfile to build a GitLab container image.</p>

<h2>
<a name="user-content-version" class="anchor" href="#version" aria-hidden="true"><span class="octicon octicon-link"></span></a>Version</h2>

<p>Current Version: 7.2.0</p>

<h1>
<a name="user-content-hardware-requirements" class="anchor" href="#hardware-requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hardware Requirements</h1>

<h2>
<a name="user-content-cpu" class="anchor" href="#cpu" aria-hidden="true"><span class="octicon octicon-link"></span></a>CPU</h2>

<ul class="task-list">
<li>1 core works for under 100 users but the responsiveness might suffer</li>
<li>2 cores is the recommended number of cores and supports up to 100 users</li>
<li>4 cores supports up to 1,000 users</li>
<li>8 cores supports up to 10,000 users</li>
</ul><h2>
<a name="user-content-memory" class="anchor" href="#memory" aria-hidden="true"><span class="octicon octicon-link"></span></a>Memory</h2>

<ul class="task-list">
<li>512MB is too little memory, GitLab will be very slow and you will need 250MB of swap</li>
<li>768MB is the minimal memory size but we advise against this</li>
<li>1GB supports up to 100 users (with individual repositories under 250MB, otherwise git memory usage necessitates using swap space)</li>
<li>
<strong>2GB</strong> is the <strong>recommended</strong> memory size and supports up to 1,000 users</li>
<li>4GB supports up to 10,000 users</li>
</ul><h2>
<a name="user-content-storage" class="anchor" href="#storage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Storage</h2>

<p>The necessary hard drive space largely depends on the size of the repos you want
to store in GitLab. But as a <em>rule of thumb</em> you should have at least twice as much
free space as your all repos combined take up. You need twice the storage because <a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/structure.md">GitLab satellites</a> contain an extra copy of each repo.</p>

<p>If you want to be flexible about growing your hard drive space in the future consider mounting it using LVM so you can add more hard drives when you need them.</p>

<p>Apart from a local hard drive you can also mount a volume that supports the network file system (NFS) protocol. This volume might be located on a file server, a network attached storage (NAS) device, a storage area network (SAN) or on an Amazon Web Services (AWS) Elastic Block Store (EBS) volume.</p>

<p>If you have enough RAM memory and a recent CPU the speed of GitLab is mainly limited by hard drive seek times. Having a fast drive (7200 RPM and up) or a solid state drive (SSD) will improve the responsiveness of GitLab.</p>

<h1>
<a name="user-content-supported-web-browsers" class="anchor" href="#supported-web-browsers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Supported Web Browsers</h1>

<ul class="task-list">
<li>Chrome (Latest stable version)</li>
<li>Firefox (Latest released version)</li>
<li>Safari 7+ (Know problem: required fields in html5 do not work)</li>
<li>Opera (Latest released version)</li>
<li>IE 10+</li>
</ul><h1>
<a name="user-content-reporting-issues" class="anchor" href="#reporting-issues" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reporting Issues</h1>

<p>Docker is a relatively new project and is active being developed and tested by a thriving community of developers and testers and every release of docker features many enhancements and bugfixes.</p>

<p>Given the nature of the development and release cycle it is very important that you have the latest version of docker installed because any issue that you encounter might have already been fixed with a newer docker release.</p>

<p>For ubuntu users I suggest <a href="https://docs.docker.com/installation/ubuntulinux/">installing docker</a> using docker's own package repository since the version of docker packaged in the ubuntu repositories are a little dated.</p>

<p>Here is the shortform of the installation of an updated version of docker on ubuntu.</p>

<div class="highlight highlight-bash"><pre>sudo apt-get purge docker.io
curl -s https://get.docker.io/ubuntu/ <span class="p">|</span> sudo sh
sudo apt-get update
sudo apt-get install lxc-docker
</pre></div>

<p>Fedora and RHEL/CentOS users should try disabling selinux with <code>setenforce 0</code> and check if resolves the issue. If it does than there is not much that I can help you with. You can either stick with selinux disabled (not recommended by redhat) or switch to using ubuntu.</p>

<p>If using the latest docker version and/or disabling selinux does not fix the issue then please file a issue request on the <a href="https://github.com/sameersbn/docker-gitlab/issues">issues</a> page.</p>

<p>In your issue report please make sure you provide the following information:</p>

<ul class="task-list">
<li>The host ditribution and release version.</li>
<li>Output of the <code>docker version</code> command</li>
<li>Output of the <code>docker info</code> command</li>
<li>The <code>docker run</code> command you used to run the image (mask out the sensitive bits).</li>
</ul><h1>
<a name="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Pull the latest version of the image from the docker index. This is the recommended method of installation as it is easier to update image in the future. These builds are performed by the <strong>Docker Trusted Build</strong> service.</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/gitlab:latest
</pre></div>

<p>Since version 6.3.0, the image builds are being tagged. You can now pull a particular version of gitlab by specifying the version number. For example,</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/gitlab:7.2.0
</pre></div>

<p>Alternately you can build the image yourself.</p>

<div class="highlight highlight-bash"><pre>git clone https://github.com/sameersbn/docker-gitlab.git
<span class="nb">cd </span>docker-gitlab
docker build --tag<span class="o">=</span><span class="s2">"$USER/gitlab"</span> .
</pre></div>

<h1>
<a name="user-content-quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h1>

<p>Run the gitlab image</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span><span class="s1">'gitlab'</span> -it --rm <span class="se">\</span>
-p 10022:22 -p 10080:80 <span class="se">\</span>
-e <span class="s1">'GITLAB_PORT=10080'</span> -e <span class="s1">'GITLAB_SSH_PORT=10022'</span> <span class="se">\</span>
sameersbn/gitlab:7.2.0
</pre></div>

<p><strong>NOTE</strong>: Please allow a couple of minutes for the GitLab application to start.</p>

<p>Point your browser to <code>http://localhost:10080</code> and login using the default username and password:</p>

<ul class="task-list">
<li>username: root</li>
<li>password: 5iveL!fe</li>
</ul><p>You should now have the GitLab application up and ready for testing. If you want to use this image in production the please read on.</p>

<h1>
<a name="user-content-configuration" class="anchor" href="#configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration</h1>

<h2>
<a name="user-content-data-store" class="anchor" href="#data-store" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data Store</h2>

<p>GitLab is a code hosting software and as such you don't want to lose your code when the docker container is stopped/deleted. To avoid losing any data, you should mount a volume at,</p>

<ul class="task-list">
<li>/home/git/data</li>
</ul><p>SELinux users are also required to change the security context of the mount point so that it plays nicely with selinux.</p>

<div class="highlight highlight-bash"><pre>mkdir -p /opt/gitlab/data
sudo chcon -Rt svirt_sandbox_file_t /opt/gitlab/data
</pre></div>

<p>Volumes can be mounted in docker by specifying the <strong>'-v'</strong> option in the docker run command.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h2>
<a name="user-content-database" class="anchor" href="#database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database</h2>

<p>GitLab uses a database backend to store its data.</p>

<h3>
<a name="user-content-mysql" class="anchor" href="#mysql" aria-hidden="true"><span class="octicon octicon-link"></span></a>MySQL</h3>

<h4>
<a name="user-content-internal-mysql-server" class="anchor" href="#internal-mysql-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Internal MySQL Server</h4>

<blockquote>
<p><strong>Warning</strong></p>

<p>The internal mysql server will soon be removed from the image.</p>

<p>Please use a linked <a href="#linking-to-mysql-container">mysql</a> or
<a href="#linking-to-postgresql-container">postgresql</a> container instead.
Or else connect with an external <a href="#external-mysql-server">mysql</a> or
<a href="#external-postgresql-server">postgresql</a> server.</p>

<p>You've been warned.</p>
</blockquote>

<p>This docker image is configured to use a MySQL database backend. The database connection can be configured using environment variables. If not specified, the image will start a mysql server internally and use it. However in this case, the data stored in the mysql database will be lost if the container is stopped/deleted. To avoid this you should mount a volume at /var/lib/mysql.</p>

<p>SELinux users are also required to change the security context of the mount point so that it plays nicely with selinux.</p>

<div class="highlight highlight-bash"><pre>mkdir -p /opt/gitlab/mysql
sudo chcon -Rt svirt_sandbox_file_t /opt/gitlab/mysql
</pre></div>

<p>The updated run command looks like this.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  -v /opt/gitlab/mysql:/var/lib/mysql sameersbn/gitlab:7.2.0
</pre></div>

<p>This will make sure that the data stored in the database is not lost when the image is stopped and started again.</p>

<h4>
<a name="user-content-external-mysql-server" class="anchor" href="#external-mysql-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>External MySQL Server</h4>

<p>The image can be configured to use an external MySQL database instead of starting a MySQL server internally. The database configuration should be specified using environment variables while starting the GitLab image.</p>

<p>Before you start the GitLab image create user and database for gitlab.</p>

<div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'gitlab'</span><span class="o">@</span><span class="s1">'%.%.%.%'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">gitlabhq_production</span><span class="o">`</span> <span class="k">DEFAULT</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="o">`</span><span class="n">utf8</span><span class="o">`</span> <span class="k">COLLATE</span> <span class="o">`</span><span class="n">utf8_unicode_ci</span><span class="o">`</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">LOCK</span> <span class="n">TABLES</span><span class="p">,</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span><span class="p">,</span> <span class="k">CREATE</span><span class="p">,</span> <span class="k">DROP</span><span class="p">,</span> <span class="k">INDEX</span><span class="p">,</span> <span class="k">ALTER</span> <span class="k">ON</span> <span class="o">`</span><span class="n">gitlabhq_production</span><span class="o">`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'gitlab'</span><span class="o">@</span><span class="s1">'%.%.%.%'</span><span class="p">;</span>
</pre></div>

<p>To make sure the database is initialized start the container with <strong>app:rake gitlab:setup</strong> option.</p>

<p><em>Assuming that the mysql server host is 192.168.1.100</em></p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm <span class="se">\</span>
  -e <span class="s1">'DB_HOST=192.168.1.100'</span> -e <span class="s1">'DB_NAME=gitlabhq_production'</span> -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:setup
</pre></div>

<p>Append <code>force=yes</code> to the above command to skip the confirmation prompt.</p>

<p><strong>NOTE: The above setup is performed only for the first run</strong>.</p>

<p>This will initialize the gitlab database. Now that the database is initialized, start the container normally.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -e <span class="s1">'DB_HOST=192.168.1.100'</span> -e <span class="s1">'DB_NAME=gitlabhq_production'</span> -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h4>
<a name="user-content-linking-to-mysql-container" class="anchor" href="#linking-to-mysql-container" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linking to MySQL Container</h4>

<p>You can link this image with a mysql container for the database requirements. The alias of the mysql server container should be set to <strong>mysql</strong> while linking with the gitlab image.</p>

<p>If a mysql container is linked, only the DB_HOST and DB_PORT settings are automatically retrieved using the linkage. You may still need to set other database connection parameters such as the DB_NAME, DB_USER, DB_PASS and so on.</p>

<p>To illustrate linking with a mysql container, we will use the <a href="https://github.com/sameersbn/docker-mysql">sameersbn/mysql</a> image. When using docker-mysql in production you should mount a volume for the mysql data store. Please refer the <a href="https://github.com/sameersbn/docker-mysql/blob/master/README.md">README</a> of docker-mysql for details.</p>

<p>First, lets pull the mysql image from the docker index.</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/mysql:latest
</pre></div>

<p>For data persistence lets create a store for the mysql and start the container.</p>

<div class="highlight highlight-bash"><pre>mkdir -p /opt/mysql/data
docker run --name<span class="o">=</span>mysql -d <span class="se">\</span>
    -v /opt/mysql/data:/var/lib/mysql <span class="se">\</span>
    sameersbn/mysql:latest
</pre></div>

<p>You should now have the mysql server running. By default the sameersbn/mysql image does not assign a password for the root user and allows remote connections for the root user from the 172.17.%.% address space. This means you can login to the mysql server from the host as the root user.</p>

<p>Now, lets login to the mysql server and create a user and database for the GitLab application.</p>

<div class="highlight highlight-bash"><pre>docker run -it --rm sameersbn/mysql:latest mysql -uroot -h<span class="k">$(</span>docker inspect --format <span class="o">{{</span>.NetworkSettings.IPAddress<span class="o">}}</span> mysql<span class="k">)</span>
</pre></div>

<div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'gitlab'</span><span class="o">@</span><span class="s1">'172.17.%.%'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">gitlabhq_production</span><span class="o">`</span> <span class="k">DEFAULT</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="o">`</span><span class="n">utf8</span><span class="o">`</span> <span class="k">COLLATE</span> <span class="o">`</span><span class="n">utf8_unicode_ci</span><span class="o">`</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">LOCK</span> <span class="n">TABLES</span><span class="p">,</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span><span class="p">,</span> <span class="k">CREATE</span><span class="p">,</span> <span class="k">DROP</span><span class="p">,</span> <span class="k">INDEX</span><span class="p">,</span> <span class="k">ALTER</span> <span class="k">ON</span> <span class="o">`</span><span class="n">gitlabhq_production</span><span class="o">`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'gitlab'</span><span class="o">@</span><span class="s1">'172.17.%.%'</span><span class="p">;</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</pre></div>

<p>Now that we have the database created for gitlab, lets install the database schema. This is done by starting the gitlab container with the <strong>app:rake gitlab:setup</strong> command.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm --link mysql:mysql <span class="se">\</span>
  -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -e <span class="s1">'DB_NAME=gitlabhq_production'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:setup
</pre></div>

<p><strong>NOTE: The above setup is performed only for the first run</strong>.</p>

<p>We are now ready to start the GitLab application.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d --link mysql:mysql <span class="se">\</span>
  -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -e <span class="s1">'DB_NAME=gitlabhq_production'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h3>
<a name="user-content-postgresql" class="anchor" href="#postgresql" aria-hidden="true"><span class="octicon octicon-link"></span></a>PostgreSQL</h3>

<h4>
<a name="user-content-external-postgresql-server" class="anchor" href="#external-postgresql-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>External PostgreSQL Server</h4>

<p>The image also supports using an external PostgreSQL Server. This is also controlled via environment variables.</p>

<div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">gitlab</span> <span class="k">with</span> <span class="n">LOGIN</span> <span class="k">CREATEDB</span> <span class="n">PASSWORD</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">gitlabhq_production</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="n">gitlabhq_production</span> <span class="k">to</span> <span class="n">gitlab</span><span class="p">;</span>
</pre></div>

<p>To make sure the database is initialized start the container with <strong>app:rake gitlab:setup</strong> option.</p>

<p><em>Assuming that the PostgreSQL server host is 192.168.1.100</em></p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm <span class="se">\</span>
  -e <span class="s1">'DB_TYPE=postgres'</span> -e <span class="s1">'DB_HOST=192.168.1.100'</span> -e <span class="s1">'DB_NAME=gitlabhq_production'</span> -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:setup
</pre></div>

<p><strong>NOTE: The above setup is performed only for the first run</strong>.</p>

<p>This will initialize the gitlab database. Now that the database is initialized, start the container normally.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -e <span class="s1">'DB_TYPE=postgres'</span> -e <span class="s1">'DB_HOST=192.168.1.100'</span> -e <span class="s1">'DB_NAME=gitlabhq_production'</span> -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h4>
<a name="user-content-linking-to-postgresql-container" class="anchor" href="#linking-to-postgresql-container" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linking to PostgreSQL Container</h4>

<p>You can link this image with a postgresql container for the database requirements. The alias of the postgresql server container should be set to <strong>postgresql</strong> while linking with the gitlab image.</p>

<p>If a postgresql container is linked, only the DB_HOST and DB_PORT settings are automatically retrieved using the linkage. You may still need to set other database connection parameters such as the DB_NAME, DB_USER, DB_PASS and so on.</p>

<p>To illustrate linking with a postgresql container, we will use the <a href="https://github.com/sameersbn/docker-postgresql">sameersbn/postgresql</a> image. When using postgresql image in production you should mount a volume for the postgresql data store. Please refer the <a href="https://github.com/sameersbn/docker-postgresql/blob/master/README.md">README</a> of docker-postgresql for details.</p>

<p>First, lets pull the postgresql image from the docker index.</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/postgresql:latest
</pre></div>

<p>For data persistence lets create a store for the postgresql and start the container.</p>

<div class="highlight highlight-bash"><pre>mkdir -p /opt/postgresql/data
docker run --name<span class="o">=</span>postgresql -d <span class="se">\</span>
  -v /opt/postgresql/data:/var/lib/postgresql <span class="se">\</span>
  sameersbn/postgresql:latest
</pre></div>

<p>You should now have the postgresql server running. The password for the postgres user can be found in the logs of the postgresql image.</p>

<div class="highlight highlight-bash"><pre>docker logs postgresql
</pre></div>

<p>Now, lets login to the postgresql server and create a user and database for the GitLab application.</p>

<div class="highlight highlight-bash"><pre>docker run -it --rm sameersbn/postgresql:latest psql -U postgres -h <span class="k">$(</span>docker inspect --format <span class="o">{{</span>.NetworkSettings.IPAddress<span class="o">}}</span> postgresql<span class="k">)</span>
</pre></div>

<div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">gitlab</span> <span class="k">with</span> <span class="n">LOGIN</span> <span class="k">CREATEDB</span> <span class="n">PASSWORD</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">gitlabhq_production</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="n">gitlabhq_production</span> <span class="k">to</span> <span class="n">gitlab</span><span class="p">;</span>
</pre></div>

<p>Now that we have the database created for gitlab, lets install the database schema. This is done by starting the gitlab container with the <strong>app:rake gitlab:setup</strong> command.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm --link postgresql:postgresql <span class="se">\</span>
  -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -e <span class="s1">'DB_NAME=gitlabhq_production'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:setup
</pre></div>

<p><strong>NOTE: The above setup is performed only for the first run</strong>.</p>

<p>We are now ready to start the GitLab application.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d --link postgresql:postgresql <span class="se">\</span>
  -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -e <span class="s1">'DB_NAME=gitlabhq_production'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h2>
<a name="user-content-redis" class="anchor" href="#redis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Redis</h2>

<h3>
<a name="user-content-internal-redis-server" class="anchor" href="#internal-redis-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Internal Redis Server</h3>

<blockquote>
<p><strong>Warning</strong></p>

<p>The internal redis server will soon be removed from the image.</p>

<p>Please use a linked <a href="#linking-to-redis-container">redis</a> container
or a external <a href="#external-redis-server">redis</a> server</p>

<p>You've been warned.</p>
</blockquote>

<p>GitLab uses the redis server for its key-value data store. The redis server connection details can be specified using environment variables. If not specified, the  starts a redis server internally, no additional configuration is required.</p>

<h3>
<a name="user-content-external-redis-server" class="anchor" href="#external-redis-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>External Redis Server</h3>

<p>The image can be configured to use an external redis server instead of starting a redis server internally. The configuration should be specified using environment variables while starting the GitLab image.</p>

<p><em>Assuming that the redis server host is 192.168.1.100</em></p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm <span class="se">\</span>
  -e <span class="s1">'REDIS_HOST=192.168.1.100'</span> -e <span class="s1">'REDIS_PORT=6379'</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h3>
<a name="user-content-linking-to-redis-container" class="anchor" href="#linking-to-redis-container" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linking to Redis Container</h3>

<p>You can link this image with a redis container to satisfy gitlab's redis requirement. The alias of the redis server container should be set to <strong>redisio</strong> while linking with the gitlab image.</p>

<p>To illustrate linking with a redis container, we will use the <a href="https://github.com/sameersbn/docker-redis">sameersbn/redis</a> image. Please refer the <a href="https://github.com/sameersbn/docker-redis/blob/master/README.md">README</a> of docker-redis for details.</p>

<p>First, lets pull the redis image from the docker index.</p>

<div class="highlight highlight-bash"><pre>docker pull sameersbn/redis:latest
</pre></div>

<p>Lets start the redis container</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>redis -d sameersbn/redis:latest
</pre></div>

<p>We are now ready to start the GitLab application.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d --link redis:redisio <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h3>
<a name="user-content-mail" class="anchor" href="#mail" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mail</h3>

<p>The mail configuration should be specified using environment variables while starting the GitLab image. The configuration defaults to using gmail to send emails and requires the specification of a valid username and password to login to the gmail servers.</p>

<p>The following environment variables need to be specified to get mail support to work.</p>

<ul class="task-list">
<li>SMTP_DOMAIN (defaults to <a href="http://www.gmail.com">www.gmail.com</a>)</li>
<li>SMTP_HOST (defaults to smtp.gmail.com)</li>
<li>SMTP_PORT (defaults to 587)</li>
<li>SMTP_USER</li>
<li>SMTP_PASS</li>
<li>SMTP_STARTTLS (defaults to true)</li>
<li>SMTP_AUTHENTICATION (defaults to 'login' if SMTP_USER is set)</li>
</ul><div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -e <span class="s1">'SMTP_USER=USER@gmail.com'</span> -e <span class="s1">'SMTP_PASS=PASSWORD'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h3>
<a name="user-content-ssl" class="anchor" href="#ssl" aria-hidden="true"><span class="octicon octicon-link"></span></a>SSL</h3>

<p>Access to the gitlab application can be secured using SSL so as to prevent unauthorized access to the data in your repositories. While a CA certified SSL certificate allows for verification of trust via the CA, a self signed certificates can also provide an equal level of trust verification as long as each client takes some additional steps to verify the identity of your website. I will provide instructions on achieving this towards the end of this section.</p>

<p>To secure your application via SSL you basically need two things:</p>

<ul class="task-list">
<li>Private key (.key)</li>
<li>SSL certificate (.crt)</li>
</ul><p>When using CA certified certificates, these files are provided to you by the CA. When using self-signed certificates you need to generate these files yourself. Skip the following section if you are armed with CA certified SSL certificates.</p>

<p>Jump to the <a href="#strengthening-the-server-security">Strengthening the server security</a> section if you are using a load balancer such as hipache, haproxy or nginx.</p>

<h4>
<a name="user-content-generation-of-self-signed-certificates" class="anchor" href="#generation-of-self-signed-certificates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generation of Self Signed Certificates</h4>

<p>Generation of self-signed SSL certificates involves a simple 3 step procedure.</p>

<p><strong>STEP 1</strong>: Create the server private key</p>

<div class="highlight highlight-bash"><pre>openssl genrsa -out gitlab.key 2048
</pre></div>

<p><strong>STEP 2</strong>: Create the certificate signing request (CSR)</p>

<div class="highlight highlight-bash"><pre>openssl req -new -key gitlab.key -out gitlab.csr
</pre></div>

<p><strong>STEP 3</strong>: Sign the certificate using the private key and CSR</p>

<div class="highlight highlight-bash"><pre>openssl x509 -req -days <span class="m">365</span> -in gitlab.csr -signkey gitlab.key -out gitlab.crt
</pre></div>

<p>Congratulations! you have now generated an SSL certificate thats valid for 365 days.</p>

<h4>
<a name="user-content-strengthening-the-server-security" class="anchor" href="#strengthening-the-server-security" aria-hidden="true"><span class="octicon octicon-link"></span></a>Strengthening the server security</h4>

<p>This section provides you with instructions to <a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html">strengthen your server security</a>. To achieve this we need to generate stronger DHE parameters.</p>

<div class="highlight highlight-bash"><pre>openssl dhparam -out dhparam.pem 2048
</pre></div>

<h4>
<a name="user-content-installation-of-the-ssl-certificates" class="anchor" href="#installation-of-the-ssl-certificates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation of the SSL Certificates</h4>

<p>Out of the four files generated above, we need to install the gitlab.key, gitlab.crt and dhparam.pem files at the gitlab server. The CSR file is not needed, but do make sure you safely backup the file (in case you ever need it again).</p>

<p>The default path that the gitlab application is configured to look for the SSL certificates is at /home/git/data/certs, this can however be changed using the SSL_KEY_PATH, SSL_CERTIFICATE_PATH and SSL_DHPARAM_PATH configuration options.</p>

<p>If you remember from above, the /home/git/data path is the path of the <a href="#data-store">data store</a>, which means that we have to create a folder named certs inside /opt/gitlab/data/ and copy the files into it and as a measure of security we will update the permission on the gitlab.key file to only be readable by the owner.</p>

<div class="highlight highlight-bash"><pre>mkdir -p /opt/gitlab/data/certs
cp gitlab.key /opt/gitlab/data/certs/
cp gitlab.crt /opt/gitlab/data/certs/
cp dhparam.pem /opt/gitlab/data/certs/
chmod <span class="m">400</span> /opt/gitlab/data/certs/gitlab.key
</pre></div>

<p>Great! we are now just a step away from having our application secured.</p>

<h4>
<a name="user-content-enabling-https-support" class="anchor" href="#enabling-https-support" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enabling HTTPS support</h4>

<p>HTTPS support can be enabled by setting the GITLAB_HTTPS option to true. Additionally, when using self-signed SSL certificates you need to the set SSL_SELF_SIGNED option to true as well. Assuming we are using self-signed certificates</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -e <span class="s1">'GITLAB_HTTPS=true'</span> -e <span class="s1">'SSL_SELF_SIGNED=true'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<p>In this configuration, any requests made over the plain http protocol will automatically be redirected to use the https protocol. However, this is not optimal when using a load balancer.</p>

<h4>
<a name="user-content-using-https-with-a-load-balancer" class="anchor" href="#using-https-with-a-load-balancer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using HTTPS with a load balancer</h4>

<p>Load balancers like haproxy/hipache talk to backend applications over plain http and as such, installation of ssl keys and certificates in the container are not required when using a load balancer.</p>

<p>When using a load balancer, you should set the GITLAB_HTTPS_ONLY option to false with the GITLAB_HTTPS options set to true and the SSL_SELF_SIGNED option to the appropriate value. With this in place, you should also configure the load balancer to support handling of https requests. But that is out of the scope of this document. Please refer to <a href="http://seanmcgary.com/posts/using-sslhttps-with-haproxy">Using SSL/HTTPS with HAProxy</a> for information on the subject.</p>

<p>Note that when the GITLAB_HTTPS_ONLY is disabled, the application does not perform the automatic http to https redirection and this functionality has to be configured at the load balancer which is also described in the link above. Unfortunately hipache does not come with an option to perform http to https redirection, so the only choice you really have is to switch to using haproxy or nginx for load balancing.</p>

<p>In summation, the docker command would look something like this:</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -e <span class="s1">'GITLAB_HTTPS=true'</span> -e <span class="s1">'SSL_SELF_SIGNED=true'</span> <span class="se">\</span>
  -e <span class="s1">'GITLAB_HTTPS_ONLY=false'</span> <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<p>Again, drop the <code>-e 'SSL_SELF_SIGNED=true'</code> option if you are using CA certified SSL certificates.</p>

<h4>
<a name="user-content-establishing-trust-with-your-server" class="anchor" href="#establishing-trust-with-your-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Establishing trust with your server</h4>

<p>This section deals will self-signed ssl certificates. If you are using CA certified certificates, your done.</p>

<p>This section is more of a client side configuration so as to add a level of confidence at the client to be 100 percent sure they are communicating with whom they think they.</p>

<p>This is simply done by adding the servers certificate into their list of trusted ceritficates. On ubuntu, this is done by copying the <code>gitlab.crt</code> file to <code>/usr/local/share/ca-certificates/</code> and executing <code>update-ca-certificates</code>.</p>

<p>Again, this is a client side configuration which means that everyone who is going to communicate with the server should perform this configuration on their machine. In short, distribute the gitlab.crt file among your developers and ask them to add it to their list of trusted ssl certificates. Failure to do so will result in errors that look like this:</p>

<div class="highlight highlight-bash"><pre>git clone https://git.local.host/gitlab-ce.git
fatal: unable to access <span class="s1">'https://git.local.host/gitlab-ce.git'</span>: server certificate verification failed. CAfile: /etc/ssl/certs/ca-certificates.crt CRLfile: none
</pre></div>

<p>You can do the same at the web browser. Instructions for installing the root certificate for firefox can be found <a href="http://portal.threatpulse.com/docs/sol/Content/03Solutions/ManagePolicy/SSL/ssl_firefox_cert_ta.htm">here</a>. You will find similar options chrome, just make sure you install the certificate under the authorities tab of the certificate manager dialog.</p>

<p>There you have it, thats all there is to it.</p>

<h4>
<a name="user-content-installing-trusted-ssl-server-certificates" class="anchor" href="#installing-trusted-ssl-server-certificates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Trusted SSL Server Certificates</h4>

<p>If your GitLab CI server is using self-signed SSL certificates then you should make sure the GitLab CI server certificate is trusted on the GitLab server for them to be able to talk to each other.</p>

<p>The default path image is configured to look for the trusted SSL certificates is at /home/git/data/certs/ca.crt, this can however be changed using the CA_CERTIFICATES_PATH configuration option.</p>

<p>Copy the ca.crt file into the certs directory on the <a href="#data-store">datastore</a>. The ca.crt file should contain the root certificates of all the servers you want to trust. With respect to GitLab CI, this will be the contents of the gitlab_ci.crt file as described in the <a href="https://github.com/sameersbn/docker-gitlab-ci/blob/master/README.md#ssl">README</a> of the <a href="https://github.com/sameersbn/docker-gitlab-ci">docker-gitlab-ci</a> container.</p>

<p>By default, our own server certificate <a href="#generation-of-self-signed-certificates">gitlab.crt</a> is added to the trusted certificates list.</p>

<h3>
<a name="user-content-putting-it-all-together" class="anchor" href="#putting-it-all-together" aria-hidden="true"><span class="octicon octicon-link"></span></a>Putting it all together</h3>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d -h git.local.host <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  -v /opt/gitlab/mysql:/var/lib/mysql <span class="se">\</span>
  -e <span class="s1">'GITLAB_HOST=git.local.host'</span> -e <span class="s1">'GITLAB_EMAIL=gitlab@local.host'</span> <span class="se">\</span>
  -e <span class="s1">'SMTP_USER=USER@gmail.com'</span> -e <span class="s1">'SMTP_PASS=PASSWORD'</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<p>If you are using an external mysql database</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d -h git.local.host <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  -e <span class="s1">'DB_HOST=192.168.1.100'</span> -e <span class="s1">'DB_NAME=gitlabhq_production'</span> -e <span class="s1">'DB_USER=gitlab'</span> -e <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  -e <span class="s1">'GITLAB_HOST=git.local.host'</span> -e <span class="s1">'GITLAB_EMAIL=gitlab@local.host'</span> <span class="se">\</span>
  -e <span class="s1">'SMTP_USER=USER@gmail.com'</span> -e <span class="s1">'SMTP_PASS=PASSWORD'</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<h3>
<a name="user-content-run-under-sub-uri" class="anchor" href="#run-under-sub-uri" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run under sub URI</h3>

<p>If you like to serve the GitLab under sub URI like http://localhost/gitlab, set GITLAB_RELATIVE_URL_ROOT=/gitlab or anything you like.
The path should start with slash, and should not have any trailing slashes.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="se">\</span>
  -v /opt/gitlab/data:/home/git/data <span class="se">\</span>
  -e <span class="s1">'GITLAB_RELATIVE_URL_ROOT=/gitlab'</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0
</pre></div>

<p>When you change the sub URI path, you need to recompile all precompiled assets. This can be done with either deleting tmp/cache/VERSION file under data store, or just <code>rm -Rf /PATH/TO/DATA_STORE/tmp</code>. After cleaning up cache files, restart the container.</p>

<h3>
<a name="user-content-omniauth-integration" class="anchor" href="#omniauth-integration" aria-hidden="true"><span class="octicon octicon-link"></span></a>OmniAuth Integration</h3>

<p>GitLab leverages OmniAuth to allow users to sign in using Twitter, GitHub, and other popular services. Configuring OmniAuth does not prevent standard GitLab authentication or LDAP (if configured) from continuing to work. Users can choose to sign in using any of the configured mechanisms.</p>

<p>Refer to the GitLab <a href="http://doc.gitlab.com/ce/integration/omniauth.html">documentation</a> for additional information.</p>

<h4>
<a name="user-content-google" class="anchor" href="#google" aria-hidden="true"><span class="octicon octicon-link"></span></a>Google</h4>

<p>To enable the Google OAuth2 OmniAuth provider you must register your application with Google. Google will generate a client ID and secret key for you to use. Please refer to the GitLab <a href="http://doc.gitlab.com/ce/integration/google.html">documentation</a> for the procedure to generate the client ID and secret key with google.</p>

<p>Once you have the client ID and secret keys generated, configure them using the <code>OAUTH_GOOGLE_API_KEY</code> and <code>OAUTH_GOOGLE_APP_SECRET</code> environment variables respectively.</p>

<p>For example, if your client ID is <code>xxx.apps.googleusercontent.com</code> and client secret key is <code>yyy</code>, then adding <code>-e 'OAUTH_GOOGLE_API_KEY=xxx.apps.googleusercontent.com' -e 'OAUTH_GOOGLE_APP_SECRET=yyy'</code> to the docker run command enables support for Google OAuth.</p>

<p>You can also restrict logins to a single domain by adding <code>-e 'OAUTH_GOOGLE_RESTRICT_DOMAIN=example.com'</code>. This is particularly useful when combined with <code>-e 'OAUTH_ALLOW_SSO=true'</code> and <code>-e 'OAUTH_BLOCK_AUTO_CREATED_USERS=false'</code>.</p>

<h4>
<a name="user-content-twitter" class="anchor" href="#twitter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Twitter</h4>

<p>To enable the Twitter OAuth2 OmniAuth provider you must register your application with Twitter. Twitter will generate a API key and secret for you to use. Please refer to the GitLab <a href="http://doc.gitlab.com/ce/integration/twitter.html">documentation</a> for the procedure to generate the API key and secret with twitter.</p>

<p>Once you have the API key and secret generated, configure them using the <code>OAUTH_TWITTER_API_KEY</code> and <code>OAUTH_TWITTER_APP_SECRET</code> environment variables respectively.</p>

<p>For example, if your API key is <code>xxx</code> and the API secret key is <code>yyy</code>, then adding <code>-e 'OAUTH_TWITTER_API_KEY=xxx' -e 'OAUTH_TWITTER_APP_SECRET=yyy'</code> to the docker run command enables support for Twitter OAuth.</p>

<h4>
<a name="user-content-github" class="anchor" href="#github" aria-hidden="true"><span class="octicon octicon-link"></span></a>GitHub</h4>

<p>To enable the GitHub OAuth2 OmniAuth provider you must register your application with GitHub. GitHub will generate a Client ID and secret for you to use. Please refer to the GitLab <a href="http://doc.gitlab.com/ce/integration/github.html">documentation</a> for the procedure to generate the Client ID and secret with github.</p>

<p>Once you have the Client ID and secret generated, configure them using the <code>OAUTH_GITHUB_API_KEY</code> and <code>OAUTH_GITHUB_APP_SECRET</code> environment variables respectively.</p>

<p>For example, if your Client ID is <code>xxx</code> and the Client secret is <code>yyy</code>, then adding <code>-e 'OAUTH_GITHUB_API_KEY=xxx' -e 'OAUTH_GITHUB_APP_SECRET=yyy'</code> to the docker run command enables support for GitHub OAuth.</p>

<h3>
<a name="user-content-external-issue-trackers" class="anchor" href="#external-issue-trackers" aria-hidden="true"><span class="octicon octicon-link"></span></a>External Issue Trackers</h3>

<p>GitLab can be configured to use third party issue trackers such as Redmine and Atlassian Jira. Use of third party issue trackers have to be configured on a per project basis from the project settings page. This means that the GitLab's issue tracker is always the default tracker unless specified otherwise.</p>

<h4>
<a name="user-content-redmine" class="anchor" href="#redmine" aria-hidden="true"><span class="octicon octicon-link"></span></a>Redmine</h4>

<p>Support for issue tracking using Redmine can be added by specifying the complete URL of the Redmine web server in the <code>REDMINE_URL</code> configuration option.</p>

<p>For example, if your Redmine server is accessible at <code>https://redmine.example.com</code>, then adding <code>-e 'REDMINE_URL=https://redmine.example.com'</code> to the docker run command enables Redmine support in GitLab</p>

<h4>
<a name="user-content-jira" class="anchor" href="#jira" aria-hidden="true"><span class="octicon octicon-link"></span></a>Jira</h4>

<p>Support for issue tracking using Jira can be added by specifying the complete URL of the Jira web server in the <code>JIRA_URL</code> configuration option.</p>

<p>For example, if your Jira server is accessible at <code>https://jira.example.com</code>, then adding <code>-e 'JIRA_URL=https://jira.example.com'</code> to the docker run command enables Jira support in GitLab</p>

<h3>
<a name="user-content-available-configuration-parameters" class="anchor" href="#available-configuration-parameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Available Configuration Parameters</h3>

<p><em>Please refer the docker run command options for the <code>--env-file</code> flag where you can specify all required environment variables in a single file. This will save you from writing a potentially long docker run command.</em></p>

<p>Below is the complete list of available options that can be used to customize your gitlab installation.</p>

<ul class="task-list">
<li>
<strong>GITLAB_HOST</strong>: The hostname of the GitLab server. Defaults to localhost</li>
<li>
<strong>GITLAB_PORT</strong>: The port of the GitLab server. Defaults to 80 for plain http and 443 when https is enabled.</li>
<li>
<strong>GITLAB_EMAIL</strong>: The email address for the GitLab server.  Defaults to <a href="mailto:example@example.com">example@example.com</a>.</li>
<li>
<strong>GITLAB_SIGNUP</strong>: Enable or disable user signups. Default is false.</li>
<li>
<strong>GITLAB_SIGNIN</strong>: If set to false, standard login form won't be shown on the sign-in page. Default is true.</li>
<li>
<strong>GITLAB_PROJECTS_LIMIT</strong>: Set default projects limit. Defaults to 100.</li>
<li>
<strong>GITLAB_PROJECTS_VISIBILITY</strong>: Set default projects visibility level. Possible values 'public', 'private' and 'internal'. Defaults to 'private'.</li>
<li>
<strong>GITLAB_RESTRICTED_VISIBILITY</strong>: Comma seperated list of visibility levels to restrict non-admin users to set. Possible visibility options are public, private and internal.</li>
<li>
<strong>GITLAB_BACKUPS</strong>: Setup cron job to automatic backups. Possible values disable, daily or monthly. Disabled by default</li>
<li>
<strong>GITLAB_BACKUP_EXPIRY</strong>: Configure how long to keep backups before they are deleted. By default when automated backups are disabled backups are kept forever (0 seconds), else the backups expire in 7 days (604800 seconds).</li>
<li>
<strong>GITLAB_SSH_PORT</strong>: The ssh port number. Defaults to 22.</li>
<li>
<strong>GITLAB_RELATIVE_URL_ROOT</strong>: The sub URI of the GitLab server, e.g. /gitlab. No default.</li>
<li>
<strong>GITLAB_HTTPS</strong>: Set to true to enable https support, disabled by default.</li>
<li>
<strong>GITLAB_HTTPS_ONLY</strong>: Configure access over plain http when GITLAB_HTTPS is enabled. Should be set to false when using a load balancer. Defaults to true.</li>
<li>
<strong>SSL_SELF_SIGNED</strong>: Set to true when using self signed ssl certificates. false by default.</li>
<li>
<strong>SSL_CERTIFICATE_PATH</strong>: Location of the ssl certificate. Defaults to /home/git/data/certs/gitlab.crt</li>
<li>
<strong>SSL_KEY_PATH</strong>: Location of the ssl private key. Defaults to /home/git/data/certs/gitlab.key</li>
<li>
<strong>SSL_DHPARAM_PATH</strong>: Location of the dhparam file. Defaults to /home/git/data/certs/dhparam.pem</li>
<li>
<strong>CA_CERTIFICATES_PATH</strong>: List of SSL certificates to trust. Defaults to /home/git/data/certs/ca.crt.</li>
<li>
<strong>NGINX_MAX_UPLOAD_SIZE</strong>: Maximum acceptable upload size. Defaults to 20m.</li>
<li>
<strong>REDIS_HOST</strong>: The hostname of the redis server. Defaults to localhost</li>
<li>
<strong>REDIS_PORT</strong>: The connection port of the redis server. Defaults to 6379.</li>
<li>
<strong>UNICORN_WORKERS</strong>: The number of unicorn workers to start. Defaults to 2.</li>
<li>
<strong>UNICORN_TIMEOUT</strong>: Sets the timeout of unicorn worker processes. Defaults to 60 seconds.</li>
<li>
<strong>SIDEKIQ_CONCURRENCY</strong>: The number of concurrent sidekiq jobs to run. Defaults to 5</li>
<li>
<strong>DB_TYPE</strong>: The database type. Possible values: mysql, postgres. Defaults to mysql.</li>
<li>
<strong>DB_HOST</strong>: The database server hostname. Defaults to localhost.</li>
<li>
<strong>DB_PORT</strong>: The database server port. Defaults to 3306 for mysql and 5432 for postgresql.</li>
<li>
<strong>DB_NAME</strong>: The database database name. Defaults to gitlabhq_production</li>
<li>
<strong>DB_USER</strong>: The database database user. Defaults to root</li>
<li>
<strong>DB_PASS</strong>: The database database password. Defaults to no password</li>
<li>
<strong>DB_POOL</strong>: The database database connection pool count. Defaults to 10.</li>
<li>
<strong>SMTP_DOMAIN</strong>: SMTP domain. Defaults to <a href="http://www.gmail.com">www.gmail.com</a>
</li>
<li>
<strong>SMTP_HOST</strong>: SMTP server host. Defaults to smtp.gmail.com.</li>
<li>
<strong>SMTP_PORT</strong>: SMTP server port. Defaults to 587.</li>
<li>
<strong>SMTP_USER</strong>: SMTP username.</li>
<li>
<strong>SMTP_PASS</strong>: SMTP password.</li>
<li>
<strong>SMTP_STARTTLS</strong>: Enable STARTTLS. Defaults to true.</li>
<li>
<strong>SMTP_AUTHENTICATION</strong>: Specify the SMTP authentication method. Defaults to 'login' if SMTP_USER is set.</li>
<li>
<strong>LDAP_ENABLED</strong>: Enable LDAP. Defaults to false</li>
<li>
<strong>LDAP_HOST</strong>: LDAP Host</li>
<li>
<strong>LDAP_PORT</strong>: LDAP Port. Defaults to 636</li>
<li>
<strong>LDAP_UID</strong>: LDAP UID. Defaults to sAMAccountName</li>
<li>
<strong>LDAP_METHOD</strong>: LDAP method, Possible values are ssl, tls and plain. Defaults to ssl</li>
<li>
<strong>LDAP_BIND_DN</strong>: No default.</li>
<li>
<strong>LDAP_PASS</strong>: LDAP password</li>
<li>
<strong>LDAP_ALLOW_USERNAME_OR_EMAIL_LOGIN</strong>: If enabled, GitLab will ignore everything after the first '@' in the LDAP username submitted by the user on login. Defaults to false if LDAP_UID is userPrincipalName, else true.</li>
<li>
<strong>LDAP_BASE</strong>: Base where we can search for users. No default.</li>
<li>
<strong>LDAP_USER_FILTER</strong>: Filter LDAP users. No default.</li>
<li>
<strong>OAUTH_ALLOW_SSO</strong>: This allows users to login without having a user account first. User accounts will be created automatically when authentication was successful. Defaults to false.</li>
<li>
<strong>OAUTH_BLOCK_AUTO_CREATED_USERS</strong>: Locks down those users until they have been cleared by the admin. Defaults to true.</li>
<li>
<strong>OAUTH_GOOGLE_API_KEY</strong>: Google App Client ID. No defaults.</li>
<li>
<strong>OAUTH_GOOGLE_APP_SECRET</strong>: Google App Client Secret. No defaults.</li>
<li>
<strong>OAUTH_GOOGLE_RESTRICT_DOMAIN</strong>: Google App restricted domain. No defaults.</li>
<li>
<strong>OAUTH_TWITTER_API_KEY</strong>: Twitter App API key. No defaults.</li>
<li>
<strong>OAUTH_TWITTER_APP_SECRET</strong>: Twitter App API secret. No defaults.</li>
<li>
<strong>OAUTH_GITHUB_API_KEY</strong>: GitHub App Client ID. No defaults.</li>
<li>
<strong>OAUTH_GITHUB_APP_SECRET</strong>: GitHub App Client secret. No defaults.</li>
<li>
<strong>REDMINE_URL</strong>: Location of the redmine server, e.g. <code>-e 'REDMINE_URL=https://redmine.example.com'</code>. No defaults.</li>
<li>
<strong>JIRA_URL</strong>: Location of the jira server, e.g. <code>-e 'JIRA_URL=https://jira.example.com'</code>. No defaults.</li>
</ul><h1>
<a name="user-content-maintenance" class="anchor" href="#maintenance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Maintenance</h1>

<h2>
<a name="user-content-creating-backups" class="anchor" href="#creating-backups" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating backups</h2>

<p>Gitlab defines a rake task to easily take a backup of your gitlab installation. The backup consists of all git repositories, uploaded files and as you might expect, the sql database.</p>

<p>Before taking a backup, please make sure that the gitlab image is not running for obvious reasons</p>

<div class="highlight highlight-bash"><pre>docker stop gitlab
</pre></div>

<p>To take a backup all you need to do is run the gitlab rake task to create a backup.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:backup:create
</pre></div>

<p>A backup will be created in the backups folder of the <a href="#data-store">Data Store</a></p>

<h2>
<a name="user-content-restoring-backups" class="anchor" href="#restoring-backups" aria-hidden="true"><span class="octicon octicon-link"></span></a>Restoring Backups</h2>

<p>Gitlab defines a rake task to easily restore a backup of your gitlab installation. Before performing the restore operation please make sure that the gitlab image is not running.</p>

<div class="highlight highlight-bash"><pre>docker stop gitlab
</pre></div>

<p>To restore a backup, run the image in interactive (-it) mode and pass the "app:restore" command to the container image.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:backup:restore
</pre></div>

<p>The restore operation will list all available backups in reverse chronological order. Select the backup you want to restore and gitlab will do its job.</p>

<h2>
<a name="user-content-automated-backups" class="anchor" href="#automated-backups" aria-hidden="true"><span class="octicon octicon-link"></span></a>Automated Backups</h2>

<p>The image can be configured to automatically take backups on a daily or monthly basis. Adding <code>-e 'GITLAB_BACKUPS=daily'</code> to the docker run command will enable daily backups, while <code>-e 'GITLAB_BACKUPS=monthly'</code> will enable monthly backups.</p>

<p>Daily backups are created at 4 am (UTC) everyday, while monthly backups are created on the 1st of every month at the same time as the daily backups.</p>

<p>By default, when automated backups are enabled, backups are held for a period of 7 days. While when automated backups are disabled, the backups are held for an infinite period of time. This can behaviour can be configured via the GITLAB_BACKUP_EXPIRY option.</p>

<h2>
<a name="user-content-shell-access" class="anchor" href="#shell-access" aria-hidden="true"><span class="octicon octicon-link"></span></a>Shell Access</h2>

<p>For debugging and maintenance purposes you may want access the container shell. Since the container does not allow interactive login over the SSH protocol, you can use the <a href="http://man7.org/linux/man-pages/man1/nsenter.1.html">nsenter</a> linux tool (part of the util-linux package) to access the container shell.</p>

<p>Some linux distros (e.g. ubuntu) use older versions of the util-linux which do not include the <code>nsenter</code> tool. To get around this @jpetazzo has created a nice docker image that allows you to install the <code>nsenter</code> utility and a helper script named <code>docker-enter</code> on these distros.</p>

<p>To install the nsenter tool on your host execute the following command.</p>

<div class="highlight highlight-bash"><pre>docker run --rm -v /usr/local/bin:/target jpetazzo/nsenter
</pre></div>

<p>Now you can access the container shell using the command</p>

<div class="highlight highlight-bash"><pre>sudo docker-enter gitlab
</pre></div>

<p>For more information refer <a href="https://github.com/jpetazzo/nsenter">https://github.com/jpetazzo/nsenter</a></p>

<p>Another tool named <code>nsinit</code> can also be used for the same purpose. Please refer <a href="https://jpetazzo.github.io/2014/03/23/lxc-attach-nsinit-nsenter-docker-0-9/">https://jpetazzo.github.io/2014/03/23/lxc-attach-nsinit-nsenter-docker-0-9/</a> for more information.</p>

<h1>
<a name="user-content-upgrading" class="anchor" href="#upgrading" aria-hidden="true"><span class="octicon octicon-link"></span></a>Upgrading</h1>

<p>GitLabHQ releases new versions on the 22nd of every month, bugfix releases immediately follow. I update this project almost immediately when a release is made (at least it has been the case so far). If you are using the image in production environments I recommend that you delay updates by a couple of days after the gitlab release, allowing some time for the dust to settle down.</p>

<p>To upgrade to newer gitlab releases, simply follow this 4 step upgrade procedure.</p>

<ul class="task-list">
<li>
<strong>Step 1</strong>: Update the docker image.</li>
</ul><div class="highlight highlight-bash"><pre>docker pull sameersbn/gitlab:7.2.0
</pre></div>

<ul class="task-list">
<li>
<strong>Step 2</strong>: Stop and remove the currently running image</li>
</ul><div class="highlight highlight-bash"><pre>docker stop gitlab
docker rm gitlab
</pre></div>

<ul class="task-list">
<li>
<strong>Step 3</strong>: Backup the application data.</li>
</ul><div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -it --rm <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:backup:create
</pre></div>

<ul class="task-list">
<li>
<strong>Step 4</strong>: Start the image</li>
</ul><div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="o">[</span>OPTIONS<span class="o">]</span> sameersbn/gitlab:7.2.0
</pre></div>

<h2>
<a name="user-content-rake-tasks" class="anchor" href="#rake-tasks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rake Tasks</h2>

<p>The app:rake command allows you to run gitlab rake tasks. To run a rake task simply specify the task to be executed to the app:rake command. For example, if you want to gather information about GitLab and the system it runs on.</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:env:info
</pre></div>

<p>Similarly, to import bare repositories into GitLab project instance</p>

<div class="highlight highlight-bash"><pre>docker run --name<span class="o">=</span>gitlab -d <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="se">\</span>
  sameersbn/gitlab:7.2.0 app:rake gitlab:import:repos
</pre></div>

<p>For a complete list of available rake tasks please refer <a href="https://github.com/gitlabhq/gitlabhq/tree/master/doc/raketasks">https://github.com/gitlabhq/gitlabhq/tree/master/doc/raketasks</a> or the help section of your gitlab installation.</p>

<h1>
<a name="user-content-references" class="anchor" href="#references" aria-hidden="true"><span class="octicon octicon-link"></span></a>References</h1>

<ul class="task-list">
<li><a href="https://github.com/gitlabhq/gitlabhq">https://github.com/gitlabhq/gitlabhq</a></li>
<li><a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md">https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md</a></li>
<li><a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/requirements.md">https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/requirements.md</a></li>
<li><a href="http://wiki.nginx.org/HttpSslModule">http://wiki.nginx.org/HttpSslModule</a></li>
<li><a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html">https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</a></li>
<li><a href="https://github.com/gitlabhq/gitlab-recipes/blob/master/web-server/nginx/gitlab-ssl">https://github.com/gitlabhq/gitlab-recipes/blob/master/web-server/nginx/gitlab-ssl</a></li>
<li><a href="https://github.com/jpetazzo/nsenter">https://github.com/jpetazzo/nsenter</a></li>
<li><a href="https://jpetazzo.github.io/2014/03/23/lxc-attach-nsinit-nsenter-docker-0-9/">https://jpetazzo.github.io/2014/03/23/lxc-attach-nsinit-nsenter-docker-0-9/</a></li>
</ul></article></div>